<!DOCTYPE html>
<html>
<head>
<title>INSTRUCTIONS.MD</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="steps-to-go-from-coldbox-hero-to-superhero">Steps to go from ColdBox Hero to SUPERHERO</h1>
<p>(All commands assume we are in the <code>box</code> shell unless stated otherwise.)</p>
<h2 id="create-app-folder">Create App Folder</h2>
<p>Create a new application folder where we will build our app on, call it <code>hcms</code> and place the given docker compose file in the root and the workbench folder as well.</p>
<pre class="hljs"><code><div>hcms
 + docker-compose.yaml
 + workbench
</div></code></pre>
<h2 id="starting-the-database">Starting the Database</h2>
<pre class="hljs"><code><div>docker-compose up
</div></code></pre>
<p>Now open up your favorite SQL tool and make sure you can connect with the following credentials:</p>
<pre class="hljs"><code><div>server: 127.0.0.1
port: 3307
database: cms
user: cms
password: coldbox
</div></code></pre>
<p>Your database should be online and populated with mock data.</p>
<blockquote>
<p>Tip: You can find the database export file here <code>/workbench/db/cms.sql</code>. You will also find the migrations we used and the seeder we used for populating the database under <code>/workbench/resources</code></p>
</blockquote>
<h2 id="global-dependencies">Global Dependencies</h2>
<p>Before we start let's make sure we have our global CommandBox dependencies that we will use for environment control, cfconfig for CFML portability (cfconfig - https://cfconfig.ortusbooks.com/):</p>
<pre class="hljs"><code><div>install commandbox-dotenv,commandbox-cfconfig,commandbox-cfformat
</div></code></pre>
<h2 id="creating-our-rest-hmvc-app">Creating our REST HMVC App</h2>
<p>We will now begin creating our application using CommandBox.  This will scaffold out a REST application using our <code>rest-hmvc</code> template.  It will create a modular approach to our API based on ColdBox 6</p>
<p>The following dependencies will be installed for you:</p>
<ul>
<li><code>coldbox</code> - Super HMVC Framework</li>
<li><code>testbox</code> - BDD testing library (<code>development</code> dependency)</li>
<li><code>modules/cbsecurity</code> - For securing your API</li>
<li><code>modules/cbvalidation</code> - For validating your API</li>
<li><code>modules/mementifier</code> - For marshalling objects to data</li>
<li><code>modules/relax</code> - Module for documenting, exploring and testing our API (<code>development</code> dependency)
<ul>
<li><code>modules/cbSwagger</code> - Open API support for documenting our API</li>
</ul>
</li>
<li><code>modules/route-visualizer</code> - For visualizing our routes</li>
</ul>
<pre class="hljs"><code><div>mkdir hcms --<span class="hljs-built_in">cd</span>
coldbox create app name=cms skeleton=rest-hmvc
</div></code></pre>
<p>Let's go over what is in this template.</p>
<h2 id="updating-our-env-file">Updating our <code>.env</code> file</h2>
<p>Update the environment file with the following information:</p>
<pre class="hljs"><code><div><span class="hljs-comment"># ColdBox Environment</span>
APPNAME=ColdBox
ENVIRONMENT=development

<span class="hljs-comment"># Database Information</span>
DB_CONNECTIONSTRING=jdbc:mysql://127.0.0.1:3307/cms?useSSL=<span class="hljs-literal">false</span>&amp;useUnicode=<span class="hljs-literal">true</span>&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;useLegacyDatetimeCode=<span class="hljs-literal">true</span>
DB_CLASS=com.mysql.jdbc.Driver
DB_DRIVER=MySQL
DB_HOST=127.0.0.1
DB_PORT=3307
DB_DATABASE=cms
DB_USER=cms
DB_PASSWORD=coldbox

<span class="hljs-comment"># JWT Information</span>
JWT_SECRET=

<span class="hljs-comment"># S3 Information</span>
S3_ACCESS_KEY=
S3_SECRET_KEY=
S3_REGION=us-east-1
S3_DOMAIN=amazonaws.com
</div></code></pre>
<p>This will allow for CommandBox and the servers we run have access to these environment settings. Once you do changes on the <code>.env</code> file you will need to reload the shell or even the server for changes to take effect: <code>reload or server restart</code></p>
<blockquote>
<p>We will fill out the JWT Secret later on.</p>
</blockquote>
<h2 id="cfconfig">CFConfig</h2>
<p>Let's review our <code>.cfconfig.json</code> file.</p>
<pre class="hljs"><code><div>{
	<span class="hljs-attr">"requestTimeoutEnabled"</span>:<span class="hljs-literal">true</span>,
    <span class="hljs-attr">"whitespaceManagement"</span>:<span class="hljs-string">"white-space-pref"</span>,
	<span class="hljs-attr">"requestTimeout"</span>:<span class="hljs-string">"0,0,5,0"</span>,
	<span class="hljs-attr">"cacheDefaultObject"</span>:<span class="hljs-string">"coldbox"</span>,
    <span class="hljs-attr">"caches"</span>:{
        <span class="hljs-attr">"coldbox"</span>:{
            <span class="hljs-attr">"storage"</span>:<span class="hljs-string">"true"</span>,
            <span class="hljs-attr">"type"</span>:<span class="hljs-string">"RAM"</span>,
            <span class="hljs-attr">"custom"</span>:{
                <span class="hljs-attr">"timeToIdleSeconds"</span>:<span class="hljs-string">"1800"</span>,
                <span class="hljs-attr">"timeToLiveSeconds"</span>:<span class="hljs-string">"3600"</span>
            },
            <span class="hljs-attr">"class"</span>:<span class="hljs-string">"lucee.runtime.cache.ram.RamCache"</span>,
            <span class="hljs-attr">"readOnly"</span>:<span class="hljs-string">"false"</span>
        }
    },
	<span class="hljs-attr">"datasources"</span> : {
		 <span class="hljs-attr">"${DB_DATABASE}"</span>:{
			 <span class="hljs-attr">"host"</span>:<span class="hljs-string">"${DB_HOST}"</span>,
			 <span class="hljs-attr">"dbdriver"</span>:<span class="hljs-string">"${DB_DRIVER}"</span>,
			 <span class="hljs-attr">"database"</span>:<span class="hljs-string">"${DB_DATABASE}"</span>,
			 <span class="hljs-attr">"dsn"</span>:<span class="hljs-string">"jdbc:mysql://{host}:{port}/{database}"</span>,
			 <span class="hljs-attr">"custom"</span>:<span class="hljs-string">"useUnicode=true&amp;characterEncoding=UTF-8&amp;useLegacyDatetimeCode=true&amp;autoReconnect=true"</span>,
			 <span class="hljs-attr">"port"</span>:<span class="hljs-string">"${DB_PORT}"</span>,
			 <span class="hljs-attr">"class"</span>:<span class="hljs-string">"${DB_CLASS}"</span>,
			 <span class="hljs-attr">"username"</span>:<span class="hljs-string">"${DB_USER}"</span>,
			 <span class="hljs-attr">"password"</span>:<span class="hljs-string">"${DB_PASSWORD}"</span>,
			 <span class="hljs-attr">"connectionLimit"</span>:<span class="hljs-string">"100"</span>,
			 <span class="hljs-attr">"connectionTimeout"</span>:<span class="hljs-string">"1"</span>
		 }
	}
}
</div></code></pre>
<h2 id="automatic-formatting-goodness">Automatic Formatting Goodness</h2>
<p>Let's add some automatic formatting goodness.  Open up your <code>box.json</code> and throw in this script:</p>
<pre class="hljs"><code><div><span class="hljs-string">"scripts"</span>:{
	<span class="hljs-string">"format:watch"</span> : <span class="hljs-string">"cfformat watch config,models,modules_app/api,tests/resources,tests/specs,*.cfc ./.cfformat.json"</span>
},
</div></code></pre>
<p>Now you can run <code>run-script format:watch</code> and your code will format as you type.</p>
<h2 id="start-it-up">Start it up!</h2>
<p>Let's start our server up but let's configure it to use the <code>42518</code> port so we can all share URL's</p>
<pre class="hljs"><code><div>server start port=42518
</div></code></pre>
<p>Boom!  Our REST API is now online</p>
<blockquote>
<p>Tip: <code>server log --follow</code> to see the console logs of your server, try it out. All logging messages will also appear here as well.  Great to have in a separate window.</p>
</blockquote>
<h2 id="bdd-setup-and-test-harness">BDD Setup and Test Harness</h2>
<p>Let's also discover the automated tests that were created for us.  Navigate to the following URL:
http://localhost:42518/tests/runner.cfm and you will see the test results.  Check out the specs in <code>tests/specs</code> as well.</p>
<p>Now let's try it via CommandBox CLI</p>
<pre class="hljs"><code><div>testbox run <span class="hljs-string">"http://localhost:42518/tests/runner.cfm"</span>
</div></code></pre>
<p>Now let's tell CommandBox about our runner.</p>
<pre class="hljs"><code><div>package <span class="hljs-built_in">set</span> testbox.runner=<span class="hljs-string">"http://localhost:42518/tests/runner.cfm"</span>
testbox run
</div></code></pre>
<p>Cool.  Now we can test our stuff without leaving the editor.  Let's make this even more cooler.</p>
<pre class="hljs"><code><div>testbox watch
</div></code></pre>
<p>This will start a watcher so you can do your code changes and tests will be executed automatically for you.  Go break a test and check it out.</p>
<blockquote>
<p>Hint: Type <code>&lt;ctrl&gt;+&lt;c&gt;</code> to exit out of watch mode</p>
</blockquote>
<h2 id="application-modules">Application Modules</h2>
<p>We will install several modules to assist us with the development of our API</p>
<ul>
<li><code>qb</code> - Fluent query builder for fancy queries (https://forgebox.io/view/qb)</li>
<li><code>bcrypt</code> - To enable encrypting of passwords (https://www.forgebox.io/view/BCrypt)</li>
</ul>
<pre class="hljs"><code><div>install qb,bcrypt
coldbox reinit
</div></code></pre>
<h2 id="datasource-configuration">Datasource Configuration</h2>
<p>Open <code>Application.cfc</code>  so we can add the global datasource we registered with the CFML Engine via  <code>.cfconfig.json</code></p>
<pre class="hljs"><code><div><span class="hljs-comment">// App datasource</span>
<span class="hljs-keyword">this</span>.datasource = <span class="hljs-string">"cms"</span>;
</div></code></pre>
<p>Let's do the same with the tets application: <code>/tests/Application.cfc</code></p>
<pre class="hljs"><code><div><span class="hljs-comment">// App datasource</span>
<span class="hljs-keyword">this</span>.datasource = <span class="hljs-string">"cms"</span>;
</div></code></pre>
<p>Try running the app again. If it runs, it works.  Or just issue a <code>testbox run</code></p>
<h2 id="base-integration-spec-class">Base Integration Spec Class</h2>
<p>Let's create a base spec class all of our integration tests will inherit from.  Place it under <code>tests/resources/BaseIntegrationSpec.cfc</code>.  This resource will give us a few little reusable tidbits for testing:</p>
<ul>
<li>Only unload ColdBox once ALL tests has finalized</li>
<li>Custom matcher for status codes (<code>toHaveStatus()</code>)</li>
<li>Custom matcher for cbvalidation data (<code>toHaveInvalidData()</code>)</li>
<li>A nice test reset method (<code>reset()</code>)</li>
</ul>
<pre class="hljs"><code><div>component extends=<span class="hljs-string">"coldbox.system.testing.BaseTestCase"</span> appMapping=<span class="hljs-string">"/root"</span>{

    <span class="hljs-comment">// Load on first test</span>
    <span class="hljs-keyword">this</span>.loadColdBox    = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// Never unload until the request dies</span>
	<span class="hljs-keyword">this</span>.unloadColdBox  = <span class="hljs-literal">false</span>;

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * Fixture Data
	 * --------------------------------------------------------------------------
	 * Here is the global fixture data you can use
	 */</span>

	<span class="hljs-comment">/*********************************** LIFE CYCLE Methods ***********************************/</span>

    <span class="hljs-comment">/**
     * Run Before all tests
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">beforeAll</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">super</span>.beforeAll();
        <span class="hljs-comment">// Wire up the test object with dependencies</span>
		application.wirebox.autowire( <span class="hljs-keyword">this</span> );

		<span class="hljs-comment">// Add Custom Matchers</span>
		addMatchers( {
			<span class="hljs-attr">toHaveStatus</span> : <span class="hljs-function">(<span class="hljs-params"> expectation, args = {} </span>) =&gt;</span> {
				<span class="hljs-comment">// handle both positional and named arguments</span>
				param args.statusCode = <span class="hljs-string">""</span>;
				<span class="hljs-keyword">if</span> ( structKeyExists( args, <span class="hljs-number">1</span> ) ) {
					args.statusCode = args[ <span class="hljs-number">1</span> ];
				}
				param args.message = <span class="hljs-string">""</span>;
				<span class="hljs-keyword">if</span> ( structKeyExists( args, <span class="hljs-number">2</span> ) ) {
					args.message = args[ <span class="hljs-number">2</span> ];
				}
				<span class="hljs-keyword">if</span> ( !len( args.statusCode ) ) {
					expectation.message = <span class="hljs-string">"No status code provided."</span>;
					<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
				}
				<span class="hljs-keyword">var</span> statusCode = expectation.actual.getStatusCode();
				<span class="hljs-keyword">if</span> ( statusCode != args.statusCode ) {
					expectation.message = <span class="hljs-string">"#args.message#. Received incorrect status code. Expected [#args.statusCode#]. Received [#statusCode#]."</span>;
					debug( expectation.actual.getMemento() );
					<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
				}
				<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
			},
			<span class="hljs-comment">// Verifies invalid cbValidation data</span>
			<span class="hljs-attr">toHaveInvalidData</span> : <span class="hljs-function">(<span class="hljs-params"> expectation, args = {} </span>) =&gt;</span> {
				param args.field = <span class="hljs-string">""</span>;
				<span class="hljs-keyword">if</span> ( structKeyExists( args, <span class="hljs-number">1</span> ) ) {
					args.field = args[ <span class="hljs-number">1</span> ];
				}
				param args.error = <span class="hljs-string">""</span>;
				<span class="hljs-keyword">if</span> ( structKeyExists( args, <span class="hljs-number">2</span> ) ) {
					args.error = args[ <span class="hljs-number">2</span> ];
				}
				param args.message = <span class="hljs-string">""</span>;
				<span class="hljs-keyword">if</span> ( structKeyExists( args, <span class="hljs-number">3</span> ) ) {
					args.message = args[ <span class="hljs-number">3</span> ];
				}

				<span class="hljs-comment">// If !400 then there is no invalid data</span>
				<span class="hljs-keyword">if</span> ( expectation.actual.getStatusCode() != <span class="hljs-number">400</span> ) {
					expectation.message = <span class="hljs-string">"#args.message#. Received incorrect status code. Expected [400]. Received [#expectation.actual.getStatusCode()#]."</span>;
					debug( expectation.actual.getMemento() );
					<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
				}
				<span class="hljs-comment">// If no field passed, we just check that invalid data was found</span>
				<span class="hljs-keyword">if</span> ( !len( args.field ) ) {
					<span class="hljs-keyword">if</span> ( expectation.actual.getData().isEmpty() ) {
						expectation.message = <span class="hljs-string">"#args.message#. Received incorrect status code. Expected [400]. Received [#expectation.actual.getStatusCode()#]."</span>;
						debug( expectation.actual.getMemento() );
						<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
					}
					<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
				}
				<span class="hljs-comment">// We have a field to check and it has data</span>
				<span class="hljs-keyword">if</span> (
					!structKeyExists(
						expectation.actual.getData(),
						args.field
					) || expectation.actual.getData()[ args.field ].isEmpty()
				) {
					expectation.message = <span class="hljs-string">"#args.message#. The requested field [#args.field#] does not have any invalid data."</span>;
					debug( expectation.actual.getMemento() );
					<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
				}
				<span class="hljs-comment">// Do we have any error messages to check?</span>
				<span class="hljs-keyword">if</span> ( len( args.error ) ) {
					<span class="hljs-keyword">try</span> {
						expect(
							expectation.actual.getData()[ args.field ]
								.map( <span class="hljs-function">(<span class="hljs-params"> item </span>) =&gt;</span> item.message )
								.toList()
						).toInclude( args.error );
					} <span class="hljs-keyword">catch</span> ( any e ) {
						debug( expectation.actual.getMemento() );
						rethrow;
					}
				}

				<span class="hljs-comment">// We checked and it's all good!</span>
				<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
			}
		} );
	}
	
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">afterAll</span>(<span class="hljs-params"></span>)</span>{
		<span class="hljs-keyword">super</span>.afterAll();
	}

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reset</span>(<span class="hljs-params"></span>)</span>{
		application.cbController.getLoaderService().processShutdown();
		structDelete( application, <span class="hljs-string">"wirebox"</span> );
		structDelete( application, <span class="hljs-string">"cbController"</span> );
	}

    <span class="hljs-comment">/**
     * This function is tagged as an around each handler.  All the integration tests we build
     * will be automatically rolled backed. No database corruption
     *
     * <span class="hljs-doctag">@aroundEach</span>
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wrapInTransaction</span>(<span class="hljs-params"> spec </span>) </span>{
        transaction action=<span class="hljs-string">"begin"</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-built_in">arguments</span>.spec.body();
            } <span class="hljs-keyword">catch</span> ( any e ){
                rethrow;
            } <span class="hljs-keyword">finally</span> {
                transaction action=<span class="hljs-string">"rollback"</span>;
            }
        }
    }

}
</div></code></pre>
<p>Update the <code>tests/specs/integration/EchoTests.cfc</code> to inherit from this spec and verify it works. It should look like this:</p>
<pre class="hljs"><code><div><span class="hljs-comment">/*******************************************************************************
*	Integration Test as BDD (CF10+ or Railo 4.1 Plus)
*
*	Extends the integration class: coldbox.system.testing.BaseTestCase
*
*	so you can test your ColdBox application headlessly. The 'appMapping' points by default to
*	the '/root' mapping created in the test folder Application.cfc.  Please note that this
*	Application.cfc must mimic the real one in your root, including ORM settings if needed.
*
*	The 'execute()' method is used to execute a ColdBox event, with the following arguments
*	* event : the name of the event
*	* private : if the event is private or not
*	* prePostExempt : if the event needs to be exempt of pre post interceptors
*	* eventArguments : The struct of args to pass to the event
*	* renderResults : Render back the results of the event
*******************************************************************************/</span>
component extends=<span class="hljs-string">"tests.resources.BaseIntegrationSpec"</span>{

<span class="hljs-comment">/*********************************** BDD SUITES ***********************************/</span>

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span>{

		describe( <span class="hljs-string">"My RESTFUl Service"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{

			beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> currentSpec </span>)</span>{
				<span class="hljs-comment">// Setup as a new ColdBox request, VERY IMPORTANT. ELSE EVERYTHING LOOKS LIKE THE SAME REQUEST.</span>
				setup();
			});

			it( <span class="hljs-string">"can handle invalid HTTP Calls"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
				<span class="hljs-keyword">var</span> event = execute( event=<span class="hljs-string">"v1:echo.onInvalidHTTPMethod"</span>, renderResults = <span class="hljs-literal">true</span> );
				<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"response"</span> );
				expect(	response.getError() ).toBeTrue();
				expect(	response.getStatusCode() ).toBe( <span class="hljs-number">405</span> );
			});

			it( <span class="hljs-string">"can handle global exceptions"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
				<span class="hljs-keyword">var</span> event = execute(
					event 			= <span class="hljs-string">"v1:echo.onError"</span>,
					renderResults 	= <span class="hljs-literal">true</span>,
					eventArguments	= { exception={ message=<span class="hljs-string">"unit test"</span>, detail=<span class="hljs-string">"unit test"</span>, stacktrace=<span class="hljs-string">""</span> } }
				);

				<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"response"</span> );
				expect(	response.getError() ).toBeTrue();
				expect(	response.getStatusCode() ).toBe( <span class="hljs-number">500</span> );
			});

			it( <span class="hljs-string">"can handle an echo"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
				<span class="hljs-keyword">var</span> event 		= <span class="hljs-keyword">this</span>.request( <span class="hljs-string">"/api/v1/echo/index"</span> );
				<span class="hljs-keyword">var</span> response 	= event.getPrivateValue( <span class="hljs-string">"response"</span> );
				expect(	response.getError() ).toBeFalse();
				expect(	response.getData() ).toBe( <span class="hljs-string">"Welcome to my ColdBox RESTFul Service"</span> );
			});

			it( <span class="hljs-string">"can handle missing actions"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
				<span class="hljs-keyword">var</span> event 		= <span class="hljs-keyword">this</span>.request( <span class="hljs-string">"/api/v1/echo/bogus"</span> );
				<span class="hljs-keyword">var</span> response 	= event.getPrivateValue( <span class="hljs-string">"response"</span> );
				expect(	response.getError() ).tobeTrue();
				expect(	response.getStatusCode() ).toBe( <span class="hljs-number">405</span> );
			});


		});

	}

}
</div></code></pre>
<h2 id="security-configuration">Security Configuration</h2>
<p>We will start by configuring <code>cbsecurity</code> so we can secure our app and be able to provide Json Web Tokens (JWT) for securing our app.  Once the configuration is done, we will move on to start the user registration process.</p>
<ul>
<li>Go over cbSecurity</li>
<li>Go over cbAuth</li>
<li>Go over JWT</li>
</ul>
<p>Open the <code>config/ColdBox.cfc</code> and locate the <code>moduleSettings</code>, we will be adding the following configuration for cbauth, cbsecurity and jwt. Please go over each configured setting below:</p>
<pre class="hljs"><code><div>moduleSettings = {

    cbauth = {
        <span class="hljs-comment">// Which class will provide user information for authentication</span>
        <span class="hljs-attr">userServiceClass</span> : <span class="hljs-string">"UserService"</span>
    },

    cbsecurity = {
        <span class="hljs-comment">// The global invalid authentication event or URI or URL to go if an invalid authentication occurs</span>
        <span class="hljs-string">"invalidAuthenticationEvent"</span>	: <span class="hljs-string">"v1:Echo.onAuthenticationFailure"</span>,
        <span class="hljs-comment">// Default Auhtentication Action: override or redirect when a user has not logged in</span>
        <span class="hljs-string">"defaultAuthenticationAction"</span>	: <span class="hljs-string">"override"</span>,
        <span class="hljs-comment">// The global invalid authorization event or URI or URL to go if an invalid authorization occurs</span>
        <span class="hljs-string">"invalidAuthorizationEvent"</span>		: <span class="hljs-string">"v1:Echo.onAuthorizationFailure"</span>,
        <span class="hljs-comment">// Default Authorization Action: override or redirect when a user does not have enough permissions to access something</span>
        <span class="hljs-string">"defaultAuthorizationAction"</span>	: <span class="hljs-string">"override"</span>,
        <span class="hljs-comment">// You can define your security rules here or externally via a source</span>
        <span class="hljs-string">"rules"</span>							: [
            <span class="hljs-comment">// We will add them later</span>
        ],
        <span class="hljs-comment">// The validator is an object that will validate rules and annotations and provide feedback on either authentication or authorization issues.</span>
        <span class="hljs-string">"validator"</span>						: <span class="hljs-string">"JWTService@cbsecurity"</span>,
        <span class="hljs-comment">// WireBox ID of the user service to use</span>
        <span class="hljs-string">"userService"</span>             		: <span class="hljs-string">"UserService"</span>,
        <span class="hljs-comment">// Activate security rule visualizer, defaults to false by default</span>
        <span class="hljs-string">"enableSecurityVisualizer"</span>		: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">// JWT Settings</span>
        <span class="hljs-string">"jwt"</span>                     		: {
            <span class="hljs-comment">// The jwt secret encoding key to use</span>
            <span class="hljs-string">"secretKey"</span>               : getSystemSetting( <span class="hljs-string">"JWT_SECRET"</span>, <span class="hljs-string">""</span> ),
            <span class="hljs-comment">// by default it uses the authorization bearer header, but you can also pass a custom one as well or as an rc variable.</span>
            <span class="hljs-string">"customAuthHeader"</span>        : <span class="hljs-string">"x-auth-token"</span>,
            <span class="hljs-comment">// The expiration in minutes for the jwt tokens</span>
            <span class="hljs-string">"expiration"</span>              : <span class="hljs-number">60</span>,
            <span class="hljs-comment">// encryption algorithm to use, valid algorithms are: HS256, HS384, and HS512</span>
            <span class="hljs-string">"algorithm"</span>               : <span class="hljs-string">"HS512"</span>,
            <span class="hljs-comment">// Which claims neds to be present on the jwt token or `TokenInvalidException` upon verification and decoding</span>
            <span class="hljs-string">"requiredClaims"</span>          : [] ,
            <span class="hljs-comment">// The token storage settings</span>
            <span class="hljs-string">"tokenStorage"</span>            : {
                <span class="hljs-comment">// enable or not, default is true</span>
                <span class="hljs-string">"enabled"</span>       : <span class="hljs-literal">true</span>,
                <span class="hljs-comment">// A cache key prefix to use when storing the tokens</span>
                <span class="hljs-string">"keyPrefix"</span>     : <span class="hljs-string">"cbjwt_"</span>,
                <span class="hljs-comment">// The driver to use: db, cachebox or a WireBox ID</span>
                <span class="hljs-string">"driver"</span>        : <span class="hljs-string">"db"</span>,
                <span class="hljs-comment">// Driver specific properties</span>
                <span class="hljs-string">"properties"</span>    : {
                    <span class="hljs-string">"table"</span> : <span class="hljs-string">"cbjwt"</span>
                }
            }
        }
    }
}
</div></code></pre>
<h3 id="jwt-secret-key">JWT Secret Key</h3>
<p>Let's add the JWT Secret now, let's begin by generating a secret key. Go to CommandBox and let's generate one:</p>
<pre class="hljs"><code><div><span class="hljs-comment">#generateSecretKey blowfish 256</span>

&gt;/TvWsL6k2Ap2/wbDroYmM9WT5JF/PndOdlzpJQEqUuI=
</div></code></pre>
<p>Please note that this is not necessary in the latest version of cbSecurity. cbSecurity will generate a new jwt secret each time the application expires and reloads. Which can also be nice to have.  You decide the approach!</p>
<p>Copy the output of the key and paste it into the <code>.env</code> setting called <code>JWT_SECRET</code></p>
<pre class="hljs"><code><div>JWT_SECRET=/TvWsL6k2Ap2/wbDroYmM9WT5JF/PndOdlzpJQEqUuI=
</div></code></pre>
<p>Now we need to reinit our server since we added a new secret. Also, CommandBox CLI doesn't know about it, since you just added it, so let's reload the shell as well.  Go to CommandBox:</p>
<pre class="hljs"><code><div>// Reload the shell
reload

// restar the server
restart
</div></code></pre>
<h3 id="securfity-visualizer">Securfity Visualizer</h3>
<p>Go to http://127.0.0.1:42518/cbsecurity and you can see the security visualizer.  Super useful!</p>
<p>That's it!  Make sure your tests work: <code>testbox run</code></p>
<h2 id="registration">Registration</h2>
<p>Let's focus now on the user registration requirement. This is the BDD story to complete:</p>
<pre class="hljs"><code><div>story( <span class="hljs-string">"I want to be able to register users in my system and assign them a JWT token upon registration"</span> );
</div></code></pre>
<p>Let's start by modeling our user object, which our rest template has already pre-built for us: <code>models/Users.cfc</code></p>
<h3 id="usercfc"><code>User.cfc</code></h3>
<p>Here are the properties we want to model, so make the appropriate changes in the pre-built user object.</p>
<ul>
<li><code>id</code></li>
<li><code>name</code></li>
<li><code>email</code></li>
<li><code>username</code></li>
<li><code>password</code></li>
<li><code>createdDate:date</code></li>
<li><code>modifiedDate:date</code></li>
</ul>
<p>We will create the model object and a basic compile unit test:</p>
<pre class="hljs"><code><div>coldbox create model name=<span class="hljs-string">"User"</span>  properties=<span class="hljs-string">"id,name,email,username,password,createdDate:date,modifiedDate:date"</span>
</div></code></pre>
<p>Let's open the file and add some initialization procedures and a utility method to know if the User object has been populated from the database or not: <code>isLoaded()</code>.  We will also add instructions for the <code>mementifier</code> module to know how to convert the object to JSON, and our validation constraints.</p>
<pre class="hljs"><code><div>component accessors=<span class="hljs-string">"true"</span> {

	<span class="hljs-comment">// DI</span>
	property name=<span class="hljs-string">"qb"</span> inject=<span class="hljs-string">"provider:QueryBuilder@qb"</span>;

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * Properties
	 * --------------------------------------------------------------------------
	 */</span>

	<span class="hljs-comment">// Properties</span>
	property name=<span class="hljs-string">"id"</span>           type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"name"</span>         type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"email"</span>        type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"username"</span>     type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"password"</span>     type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"createdDate"</span>  type=<span class="hljs-string">"date"</span>;
    property name=<span class="hljs-string">"modifiedDate"</span> type=<span class="hljs-string">"date"</span>;
	property name=<span class="hljs-string">"permissions"</span>  type=<span class="hljs-string">"array"</span>;

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * Mementifier
	 * --------------------------------------------------------------------------
	 */</span>
	<span class="hljs-keyword">this</span>.memento = {
		<span class="hljs-attr">defaultIncludes</span> : [ <span class="hljs-string">"*"</span> ],
		<span class="hljs-attr">defaultExcludes</span> : [],
		<span class="hljs-attr">neverInclude</span>    : [ <span class="hljs-string">"password"</span> ]
	};

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * Validation
	 * --------------------------------------------------------------------------
	 */</span>
	<span class="hljs-keyword">this</span>.constraints = {
		<span class="hljs-attr">name</span>    : { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span> },
		<span class="hljs-attr">email</span>    : { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span> : <span class="hljs-string">"email"</span> },
		<span class="hljs-attr">username</span>    : { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span>, <span class="hljs-attr">udf</span> : <span class="hljs-function">(<span class="hljs-params"> value, target </span>) =&gt;</span> {
			<span class="hljs-keyword">if</span>( isNull( <span class="hljs-built_in">arguments</span>.value ) ) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">return</span> qb.from( <span class="hljs-string">"users"</span> ).where( <span class="hljs-string">"username"</span>, <span class="hljs-built_in">arguments</span>.value ).count() == <span class="hljs-number">0</span>;
        }},
        <span class="hljs-attr">password</span>    : { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span> }
	};

	<span class="hljs-comment">/**
	 * Constructor
	 */</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{
		variables.permissions = [];
		variables.createdDate = now();
		variables.modifiedDate = now();

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
	}

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * Authentication/Authorization Methods
	 * --------------------------------------------------------------------------
	 */</span>

	<span class="hljs-comment">/**
	 * Check if a user is loaded from the db or not
	 */</span>
	boolean <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isLoaded</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> ( !isNull( variables.id ) &amp;&amp; len( variables.id ) );
	}

	<span class="hljs-comment">/**
	 * Verify if the user has one or more of the passed in permissions
	 *
	 * <span class="hljs-doctag">@permission </span>One or a list of permissions to check for access
	 *
	 */</span>
	boolean <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasPermission</span>(<span class="hljs-params"> required permission </span>) </span>{
		<span class="hljs-comment">// If no permissions, then it a default value of true comes in</span>
		<span class="hljs-keyword">if</span> ( isBoolean( <span class="hljs-built_in">arguments</span>.permission ) &amp;&amp; <span class="hljs-built_in">arguments</span>.permission ) {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
		}

		<span class="hljs-keyword">if</span> ( isSimpleValue( <span class="hljs-built_in">arguments</span>.permission ) ) {
			<span class="hljs-built_in">arguments</span>.permission = listToArray( <span class="hljs-built_in">arguments</span>.permission );
		}

		<span class="hljs-keyword">return</span> <span class="hljs-built_in">arguments</span>.permission
			.filter( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> item </span>) </span>{
				<span class="hljs-keyword">return</span> ( variables.permissions.findNoCase( item ) );
			} )
			.len();
	}

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * IJwtSubject Methods
	 * --------------------------------------------------------------------------
	 */</span>

	<span class="hljs-comment">/**
	 * A struct of custom claims to add to the JWT token
	 */</span>
	struct <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getJwtCustomClaims</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> {};
	}

	<span class="hljs-comment">/**
	 * This function returns an array of all the scopes that should be attached to the JWT token that will be used for authorization.
	 */</span>
	array <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getJwtScopes</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> [];
	}

}
</div></code></pre>
<p>Now open the unit test: <code>/tests/specs/unit/UserTest.cfc</code> and update it to this:</p>
<pre class="hljs"><code><div>describe( <span class="hljs-string">"A User"</span>, function(){

    it( <span class="hljs-string">"can be created"</span>, function(){
        expect( model ).toBeComponent();
    });

});
</div></code></pre>
<p>Run your tests! We have broken a few things, but we will get them sorted out soon.</p>
<h3 id="authentication-and-jwtsubject">Authentication and JWTSubject</h3>
<p>Since we will be using cbsecurity's authentication service (<strong>cbauth</strong>) and it's jwt services, let's make sure our User object adhers to those requirements by implementing the methods it asks us to do. We won't test them, since those will be tested by the integration portions.</p>
<p><code>IAuthUser</code> - https://coldbox-security.ortusbooks.com/usage/authentication-services#user-interface</p>
<p>We will skip adding the <code>getId()</code> function since that is added already by the accessor.  We don't have any permissions yet in the system, so we will always return true, and for <code>isLoggedIn()</code> we will delegate to cbauth (<code>authenticationService@cbauth</code>).</p>
<pre class="hljs"><code><div>interface{

    <span class="hljs-comment">/**
     * Return the unique identifier for the user
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getId</span>(<span class="hljs-params"></span>);

    /**
     * <span class="hljs-title">Verify</span> <span class="hljs-title">if</span> <span class="hljs-title">the</span> <span class="hljs-title">user</span> <span class="hljs-title">has</span> <span class="hljs-title">one</span> <span class="hljs-title">or</span> <span class="hljs-title">more</span> <span class="hljs-title">of</span> <span class="hljs-title">the</span> <span class="hljs-title">passed</span> <span class="hljs-title">in</span> <span class="hljs-title">permissions</span>
     *
     * @<span class="hljs-title">permission</span> <span class="hljs-title">One</span> <span class="hljs-title">or</span> <span class="hljs-title">a</span> <span class="hljs-title">list</span> <span class="hljs-title">of</span> <span class="hljs-title">permissions</span> <span class="hljs-title">to</span> <span class="hljs-title">check</span> <span class="hljs-title">for</span> <span class="hljs-title">access</span>
     *
     */
    <span class="hljs-title">boolean</span> <span class="hljs-title">function</span> <span class="hljs-title">hasPermission</span>(<span class="hljs-params"> required permission </span>);

    /**
     * <span class="hljs-title">Shortcut</span> <span class="hljs-title">to</span> <span class="hljs-title">verify</span> <span class="hljs-title">it</span> <span class="hljs-title">the</span> <span class="hljs-title">user</span> <span class="hljs-title">is</span> <span class="hljs-title">logged</span> <span class="hljs-title">in</span> <span class="hljs-title">or</span> <span class="hljs-title">not</span>.
     */
    <span class="hljs-title">boolean</span> <span class="hljs-title">function</span> <span class="hljs-title">isLoggedIn</span>(<span class="hljs-params"></span>);

}
</span></div></code></pre>
<p><code>IJwtSubject</code> - https://coldbox-security.ortusbooks.com/jwt/jwt-services#jwt-subject-interface</p>
<p>For now we won't have any custom claims or custom security scopes.  Maybe later on in our training we will add them.</p>
<pre class="hljs"><code><div>interface{

    <span class="hljs-comment">/**
     * A struct of custom claims to add to the JWT token
     */</span>
    struct <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getJwtCustomClaims</span>(<span class="hljs-params"></span>);

    /**
     * <span class="hljs-title">This</span> <span class="hljs-title">function</span> <span class="hljs-title">returns</span> <span class="hljs-title">an</span> <span class="hljs-title">array</span> <span class="hljs-title">of</span> <span class="hljs-title">all</span> <span class="hljs-title">the</span> <span class="hljs-title">scopes</span> <span class="hljs-title">that</span> <span class="hljs-title">should</span> <span class="hljs-title">be</span> <span class="hljs-title">attached</span> <span class="hljs-title">to</span> <span class="hljs-title">the</span> <span class="hljs-title">JWT</span> <span class="hljs-title">token</span> <span class="hljs-title">that</span> <span class="hljs-title">will</span> <span class="hljs-title">be</span> <span class="hljs-title">used</span> <span class="hljs-title">for</span> <span class="hljs-title">authorization</span>.
     */
    <span class="hljs-title">array</span> <span class="hljs-title">function</span> <span class="hljs-title">getJwtScopes</span>(<span class="hljs-params"></span>);

}
</span></div></code></pre>
<p>So our <code>User.cfc</code> will end up like this:</p>
<pre class="hljs"><code><div>component accessors=<span class="hljs-string">"true"</span> {

	<span class="hljs-comment">// DI</span>
	property name=<span class="hljs-string">"qb"</span> inject=<span class="hljs-string">"provider:QueryBuilder@qb"</span>;

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * Properties
	 * --------------------------------------------------------------------------
	 */</span>

	<span class="hljs-comment">// Properties</span>
	property name=<span class="hljs-string">"id"</span>           type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"name"</span>         type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"email"</span>        type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"username"</span>     type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"password"</span>     type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"createdDate"</span>  type=<span class="hljs-string">"date"</span>;
    property name=<span class="hljs-string">"modifiedDate"</span> type=<span class="hljs-string">"date"</span>;
	property name=<span class="hljs-string">"permissions"</span>  type=<span class="hljs-string">"array"</span>;

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * Mementifier
	 * --------------------------------------------------------------------------
	 */</span>
	<span class="hljs-keyword">this</span>.memento = {
		<span class="hljs-attr">defaultIncludes</span> : [ <span class="hljs-string">"*"</span> ],
		<span class="hljs-attr">defaultExcludes</span> : [],
		<span class="hljs-attr">neverInclude</span>    : [ <span class="hljs-string">"password"</span> ]
	};

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * Validation
	 * --------------------------------------------------------------------------
	 */</span>
	<span class="hljs-keyword">this</span>.constraints = {
		<span class="hljs-attr">name</span>    : { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span> },
		<span class="hljs-attr">email</span>    : { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span> : <span class="hljs-string">"email"</span> },
		<span class="hljs-attr">username</span>    : { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span>, <span class="hljs-attr">udf</span> : <span class="hljs-function">(<span class="hljs-params"> value, target </span>) =&gt;</span> {
			<span class="hljs-keyword">if</span>( isNull( <span class="hljs-built_in">arguments</span>.value ) ) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">return</span> qb.from( <span class="hljs-string">"users"</span> ).where( <span class="hljs-string">"username"</span>, <span class="hljs-built_in">arguments</span>.value ).count() == <span class="hljs-number">0</span>;
        }},
        <span class="hljs-attr">password</span>    : { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span> }
	};

	<span class="hljs-comment">/**
	 * Constructor
	 */</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{
		variables.permissions = [];
		variables.createdDate = now();
		variables.modifiedDate = now();

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
	}

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * Authentication/Authorization Methods
	 * --------------------------------------------------------------------------
	 */</span>

	<span class="hljs-comment">/**
	 * Check if a user is loaded from the db or not
	 */</span>
	boolean <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isLoaded</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> ( !isNull( variables.id ) &amp;&amp; len( variables.id ) );
	}

	<span class="hljs-comment">/**
	 * Verify if the user has one or more of the passed in permissions
	 *
	 * <span class="hljs-doctag">@permission </span>One or a list of permissions to check for access
	 *
	 */</span>
	boolean <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasPermission</span>(<span class="hljs-params"> required permission </span>) </span>{
		<span class="hljs-comment">// If no permissions, then it a default value of true comes in</span>
		<span class="hljs-keyword">if</span> ( isBoolean( <span class="hljs-built_in">arguments</span>.permission ) &amp;&amp; <span class="hljs-built_in">arguments</span>.permission ) {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
		}

		<span class="hljs-keyword">if</span> ( isSimpleValue( <span class="hljs-built_in">arguments</span>.permission ) ) {
			<span class="hljs-built_in">arguments</span>.permission = listToArray( <span class="hljs-built_in">arguments</span>.permission );
		}

		<span class="hljs-keyword">return</span> <span class="hljs-built_in">arguments</span>.permission
			.filter( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> item </span>) </span>{
				<span class="hljs-keyword">return</span> ( variables.permissions.findNoCase( item ) );
			} )
			.len();
	}

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * IJwtSubject Methods
	 * --------------------------------------------------------------------------
	 */</span>

	<span class="hljs-comment">/**
	 * A struct of custom claims to add to the JWT token
	 */</span>
	struct <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getJwtCustomClaims</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> {};
	}

	<span class="hljs-comment">/**
	 * This function returns an array of all the scopes that should be attached to the JWT token that will be used for authorization.
	 */</span>
	array <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getJwtScopes</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> [];
	}

}
</div></code></pre>
<h3 id="bdd-integration">BDD Integration</h3>
<p>Now that our model is complete and satisfies the <strong>cbsecurity</strong> requirements for authentication and jwt services let's focus on the actual registration. We will create our BDD spec first to write down our requirements.  We will then proceed to create the implementation.</p>
<p>Our template comes with a handler for authentication and an integration test as well:</p>
<ul>
<li><code>modules_app/api/modules_app/v1/handlers/Auth.cfc</code></li>
<li><code>tests/specs/integration/AuthTests.cfc</code></li>
</ul>
<p>Let's open our test and modify it a bit by making sure it inherits from our base class, remove some boilerplate and also update it for our new model.  Also, let's comment out the stories pre-generated for us so we can focus only on the registration story (Use the <code>x</code> prefix)</p>
<p>It should end up like this:</p>
<pre class="hljs"><code><div>component extends=<span class="hljs-string">"tests.resources.BaseIntegrationSpec"</span>{

	property name=<span class="hljs-string">"jwtService"</span> inject=<span class="hljs-string">"provider:JwtService@cbsecurity"</span>;
	property name=<span class="hljs-string">"cbauth"</span>     inject=<span class="hljs-string">"provider:authenticationService@cbauth"</span>;

	<span class="hljs-comment">/*********************************** BDD SUITES ***********************************/</span>

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
		describe( <span class="hljs-string">"RESTFul Authentication"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
			beforeEach( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> currentSpec </span>) </span>{
				<span class="hljs-comment">// Setup as a new ColdBox request, VERY IMPORTANT. ELSE EVERYTHING LOOKS LIKE THE SAME REQUEST.</span>
				setup();

				<span class="hljs-comment">// Make sure nothing is logged in to start our calls</span>
				cbauth.logout();
				jwtService.getTokenStorage().clearAll();
			} );

			xstory( <span class="hljs-string">"I want to authenticate a user and receive a JWT token"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				given( <span class="hljs-string">"a valid email and password"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"I will be authenticated and will receive the JWT token"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
						<span class="hljs-comment">// Use a user in the seeded db</span>
						<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>.post(
							route  = <span class="hljs-string">"/api/v1/login"</span>,
							params = {
								<span class="hljs-attr">email</span>    : <span class="hljs-string">"admin@coldbox.org"</span>,
								<span class="hljs-attr">password</span> : <span class="hljs-string">"admin"</span>
							}
						);
						<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );
						expect( response.getError() ).toBeFalse( response.getMessages().toString() );
						expect( response.getData() ).toBeString();

						debug( response.getData() );

						<span class="hljs-keyword">var</span> decoded = jwtService.decode( response.getData() );
						expect( decoded.sub ).toBe( <span class="hljs-number">1</span> );
						expect( decoded.exp ).toBeGTE( dateAdd( <span class="hljs-string">"h"</span>, <span class="hljs-number">1</span>, decoded.iat ) );
					} );
				} );
				given( <span class="hljs-string">"invalid email and password"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"I will receive a 401 exception "</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
						<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>.post(
							route  = <span class="hljs-string">"/api/v1/login"</span>,
							params = {
								<span class="hljs-attr">email</span>    : <span class="hljs-string">"invalid"</span>,
								<span class="hljs-attr">password</span> : <span class="hljs-string">"invalid"</span>
							}
						);
						<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );
						expect( response.getError() ).toBeTrue();
						expect( response.getStatusCode() ).toBe( <span class="hljs-number">401</span> );
					} );
				} );
			} );

			story( <span class="hljs-string">"I want to register into the system"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				given( <span class="hljs-string">"valid registration details"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"I should register, log in and get a token"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
						<span class="hljs-comment">// Use a user in the seeded db</span>
						<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>.post(
							route  = <span class="hljs-string">"/api/v1/register"</span>,
							params = {
								<span class="hljs-attr">name</span>    : <span class="hljs-string">"luis Majano"</span>,
								<span class="hljs-attr">email</span>    : <span class="hljs-string">"lmajano@coldbox.org"</span>,
								<span class="hljs-attr">username</span> : <span class="hljs-string">"lmajano"</span>,
								<span class="hljs-attr">password</span> : <span class="hljs-string">"lmajano"</span>
							}
						);
						<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );
						
						debug( response.getData() );
						
						expect( response ).toHaveStatus( <span class="hljs-number">200</span> );
						expect( response.getData() ).toHaveKey( <span class="hljs-string">"token,user"</span> );
	
						<span class="hljs-keyword">var</span> decoded = jwtService.decode( response.getData().token );
						expect( decoded.sub ).toBe( response.getData().user.id );
						expect( decoded.exp ).toBeGTE( dateAdd( <span class="hljs-string">"h"</span>, <span class="hljs-number">1</span>, decoded.iat ) );
					} );
				} );
				given( <span class="hljs-string">"invalid registration details"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"I should get an error message"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
						<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>.post(
							route  = <span class="hljs-string">"/api/v1/register"</span>,
							params = {
								<span class="hljs-attr">email</span>    : <span class="hljs-string">"invalid"</span>,
								<span class="hljs-attr">password</span> : <span class="hljs-string">"invalid"</span>
							}
						);
						<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );
						expect( event.getResponse() ).toHaveStatus( <span class="hljs-number">400</span> );
					} );
				} );
				xgiven( <span class="hljs-string">"valid registration data but with a non-unique username"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
					then( <span class="hljs-string">"a validation message should be sent to the user with an error message"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{

					});
				} );
			} );

			xstory( <span class="hljs-string">"I want to be able to logout from the system using my JWT token"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				given( <span class="hljs-string">"a valid incoming jwt token"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"my token should become invalidated and I will be logged out"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
						<span class="hljs-comment">// Log in first to get a valid token to logout with</span>
						<span class="hljs-keyword">var</span> token   = jwtService.attempt( <span class="hljs-string">"admin@coldbox.org"</span>, <span class="hljs-string">"admin"</span> );
						<span class="hljs-keyword">var</span> payload = jwtService.decode( token );
						expect( cbauth.isLoggedIn() ).toBeTrue();

						<span class="hljs-comment">// Now Logout</span>
						<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>.post( route = <span class="hljs-string">"/api/v1/logout"</span>, params = { <span class="hljs-string">"x-auth-token"</span> : token } );

						<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );
						expect( response.getError() ).toBeFalse( response.getMessages().toString() );
						expect( response.getStatusCode() ).toBe( <span class="hljs-number">200</span> );
						expect( cbauth.isLoggedIn() ).toBeFalse();
					} );
				} );
				given( <span class="hljs-string">"an invalid incoming jwt token"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"I should see an error message"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
						<span class="hljs-comment">// Now Logout</span>
						<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>.post( route = <span class="hljs-string">"/api/v1/logout"</span>, params = { <span class="hljs-string">"x-auth-token"</span> : <span class="hljs-string">"123"</span> } );

						<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );
						expect( response.getError() ).toBeTrue( response.getMessages().toString() );
						debug( response.getStatusCode( <span class="hljs-number">500</span> ) );
					} );
				} );
			} );
		} );
	}

}
</div></code></pre>
<p>Run it, it will run but some things are failing now, since we where basically mocking things before. So we will be fixing each story one by one until our entire auth procedures are done with.</p>
<h3 id="routing">Routing</h3>
<p>Open the <code>v1</code> module's router: <code>modules_app/api/modules_app/v1/config/Router.cfc</code> and add our routing or verify that we have all of our necessary routes:</p>
<pre class="hljs"><code><div>component{

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configure</span>(<span class="hljs-params"></span>)</span>{

		<span class="hljs-comment">// API Echo</span>
		<span class="hljs-keyword">get</span>( "/", "Echo.index" );

		// API Authentication Routes
		post( "/login", "Auth.login" );
		post( "/logout", "Auth.logout" );
		post( "/register", "Auth.register" );

		// API Secured Routes
		<span class="hljs-keyword">get</span>( "/whoami", "Echo.whoami" );

		route( "/:handler/:action" ).end();
    }

}
</div></code></pre>
<p>Issue a <code>coldbox reinit</code> and check out the Route Visualizer: http://127.0.0.1:42518/route-visualizer</p>
<h3 id="event-handler">Event Handler</h3>
<p>Now that we have our route, let's fill out our event handler for registration only.  Open the <code>auth.cfc</code> in our <code>v1</code> module and let's code it out.  We will need to populate a new user object from incoming <code>rc</code> data, validate it, create it and then tell the cbsecurity's jwt services to create a token for the user.  Also remember that our handler's MUST Inherit from our <code>coldbox.system.RestHandler</code>, which is new in ColdBox 6.</p>
<ul>
<li>Investigate RestHandler and what you get.</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-comment">/**
 * Register a new user in the system
 *
 * <span class="hljs-doctag">@x</span>-route (POST) /api/v1/register
 * <span class="hljs-doctag">@requestBody </span>~api/v1/auth/register/requestBody.json
 * <span class="hljs-doctag">@response</span>-default ~api/v1/auth/register/responses.json##200
 * <span class="hljs-doctag">@response</span>-400 ~api/v1/auth/register/responses.json##400
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span>(<span class="hljs-params"> event, rc, prc </span>) </span>{
	param rc.fname    = <span class="hljs-string">""</span>;
	param rc.lname    = <span class="hljs-string">""</span>;
	param rc.email    = <span class="hljs-string">""</span>;
	param rc.password = <span class="hljs-string">""</span>;

	<span class="hljs-comment">// Populate, Validate, Create a new user</span>
	prc.oUser = userService.create( validateOrFail( populateModel( <span class="hljs-string">"User"</span> ) ) );

	<span class="hljs-comment">// Log them in if it was created!</span>
	event
		.getResponse()
		.setData( {
			<span class="hljs-string">"token"</span> : jwtAuth().fromuser( prc.oUser ),
			<span class="hljs-string">"user"</span>  : prc.oUser.getMemento()
		} )
		.addMessage(
			<span class="hljs-string">"User registered correctly and Bearer token created and it expires in #jwtAuth().getSettings().jwt.expiration# minutes"</span>
		);
}
</div></code></pre>
<p>Once we write up this code, two new scenarios should pop up in your head:</p>
<pre class="hljs"><code><div>given( <span class="hljs-string">"invalid registration details"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
	then( <span class="hljs-string">"I should get an error message"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

    });
} );
given( <span class="hljs-string">"valid registration data but with a non-unique username"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    then( <span class="hljs-string">"a validation message should be sent to the user with an error message"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{

    });
} );
</div></code></pre>
<p>You will have to fill these out on your own! Let's do it!</p>
<h3 id="user-services">User Services</h3>
<p>Since we must use a <code>UserService</code> in our handler, then I guess we need to build it.  How? Well, we know we need to add a <code>create()</code> method, but our template already generated one for us.  It is using mocks, so let's update it so we can actually use the database.</p>
<blockquote>
<p>Also note that we have a unit test for the UserService: <code>tests/specs/unit/UserServiceTest.cfc</code></p>
</blockquote>
<p>Here is the unit test pre-generated for us, which is enough for us to continue upon. We are not building any hard-core algorithms or anything to test in isolation.</p>
<pre class="hljs"><code><div>component extends=<span class="hljs-string">"coldbox.system.testing.BaseTestCase"</span> {

	<span class="hljs-comment">/*********************************** LIFE CYCLE Methods ***********************************/</span>

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">beforeAll</span>(<span class="hljs-params"></span>) </span>{
		structDelete( application, <span class="hljs-string">"cbController"</span> );
		structDelete( application, <span class="hljs-string">"wirebox"</span> );
		<span class="hljs-keyword">super</span>.beforeAll();
	}

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">afterAll</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">super</span>.afterAll();
	}

	<span class="hljs-comment">/*********************************** BDD SUITES ***********************************/</span>

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
		describe( <span class="hljs-string">"UserService"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
			beforeEach( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> currentSpec </span>) </span>{
				setup();
				model = getInstance( <span class="hljs-string">"UserService"</span> );
			} );

			it( <span class="hljs-string">"can be created"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				expect( model ).toBeComponent();
			} );

		} );
	}

}
</div></code></pre>
<p>Here is the code for the <code>UserService</code> using our new model approach and the methods we need to update for now:</p>
<ul>
<li><code>init()</code></li>
<li><code>create()</code></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-comment">/**
* User Services
*/</span>
component accessors=<span class="hljs-string">"true"</span> singleton {

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * DI
	 * --------------------------------------------------------------------------
	 */</span>
	property name=<span class="hljs-string">"populator"</span> 	inject=<span class="hljs-string">"wirebox:populator"</span>;
	property name=<span class="hljs-string">"bcrypt"</span>      inject=<span class="hljs-string">"@BCrypt"</span>;
	property name=<span class="hljs-string">"qb"</span>          inject=<span class="hljs-string">"provider:QueryBuilder@qb"</span>;

	<span class="hljs-comment">/**
	 * Constructor
	 */</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
	}

	<span class="hljs-comment">/**
	 * Construct a new user object via WireBox
	 */</span>
	User <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new</span>(<span class="hljs-params"></span>) <span class="hljs-title">provider</span>="<span class="hljs-title">User</span>";

	/**
	 * <span class="hljs-title">Create</span> <span class="hljs-title">a</span> <span class="hljs-title">new</span> <span class="hljs-title">user</span> <span class="hljs-title">in</span> <span class="hljs-title">the</span> <span class="hljs-title">system</span>
	 *
	 * @<span class="hljs-title">user</span> <span class="hljs-title">The</span> <span class="hljs-title">user</span> <span class="hljs-title">to</span> <span class="hljs-title">create</span>
	 *
	 * @<span class="hljs-title">return</span> <span class="hljs-title">The</span> <span class="hljs-title">created</span> <span class="hljs-title">user</span>
	 */
	<span class="hljs-title">User</span> <span class="hljs-title">function</span> <span class="hljs-title">create</span>(<span class="hljs-params"> required user </span>) </span>{
		<span class="hljs-keyword">var</span> qResults = qb.from( <span class="hljs-string">"users"</span> )
			.insert( values = {
				<span class="hljs-string">"name"</span> 		= <span class="hljs-built_in">arguments</span>.user.getName(),
				<span class="hljs-string">"email"</span> 	= <span class="hljs-built_in">arguments</span>.user.getEmail(),
				<span class="hljs-string">"username"</span> 	= <span class="hljs-built_in">arguments</span>.user.getUsername(),
				<span class="hljs-string">"password"</span> 	= bcrypt.hashPassword( <span class="hljs-built_in">arguments</span>.user.getPassword() )
			} );

		<span class="hljs-comment">// populate the id</span>
		<span class="hljs-built_in">arguments</span>.user.setId( qResults.result.generatedKey );

		<span class="hljs-keyword">return</span> <span class="hljs-built_in">arguments</span>.user;
	}
}
</div></code></pre>
<p>Now let's verify our tests and adjust as necessary, but we should have a working registration now and jwt token creations.  Also, check out your database, a new table <code>cbjwt</code> has been created for you!</p>
<p>Question, why doesn't the table have any data on it?</p>
<blockquote>
<p>Go into the base integration test and remove the <code>aroundEach</code> annotation from the <code>wrapInTransaction()</code> method, run the tests, and check out the database now. Run again, the data persists.  So be careful, decide and move on. Clear the db data if you like.</p>
</blockquote>
<h2 id="authentication">Authentication</h2>
<p>Now that we have registration complete, let's focus on authentication for our API.  Here are two stories to start with which can be found already in our auth spec.</p>
<pre class="hljs"><code><div>story( <span class="hljs-string">"I want to be able to authenticate with a username/password and receive a JWT token"</span>, function(){

} );

story( <span class="hljs-string">"I want to be able to logout from the system using my JWT token"</span>, function(){
    
} );
</div></code></pre>
<h3 id="bdd">BDD</h3>
<p>Let's start with our BDD specs before we move to the implementation phase. Let's open the <code>AuthTests</code> spec and revise our login/logout tests so they use our new model and matchers:</p>
<pre class="hljs"><code><div>component extends=<span class="hljs-string">"tests.resources.BaseIntegrationSpec"</span> {

	property name=<span class="hljs-string">"jwtService"</span> inject=<span class="hljs-string">"provider:JwtService@cbsecurity"</span>;
	property name=<span class="hljs-string">"cbauth"</span>     inject=<span class="hljs-string">"provider:authenticationService@cbauth"</span>;

	<span class="hljs-comment">/*********************************** BDD SUITES ***********************************/</span>

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
		describe( <span class="hljs-string">"RESTFul Authentication"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
			beforeEach( <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> currentSpec </span>) </span>{
				<span class="hljs-comment">// Setup as a new ColdBox request, VERY IMPORTANT. ELSE EVERYTHING LOOKS LIKE THE SAME REQUEST.</span>
				setup();

				<span class="hljs-comment">// Make sure nothing is logged in to start our calls</span>
				cbauth.logout();
				jwtService.getTokenStorage().clearAll();
			} );

			story( <span class="hljs-string">"I want to authenticate a user and receive a JWT token"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				given( <span class="hljs-string">"a valid username and password"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"I will be authenticated and will receive the JWT token"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
						<span class="hljs-comment">// Use a user in the seeded db</span>
						<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>.post(
							route  = <span class="hljs-string">"/api/v1/login"</span>,
							params = {
								<span class="hljs-attr">username</span> : <span class="hljs-string">"Milkshake10"</span>,
								<span class="hljs-attr">password</span> : <span class="hljs-string">"test"</span>
							}
						);
						<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );
						debug( response.getData() );

						expect( response ).toHaveStatus( <span class="hljs-number">200</span> );
						expect( response.getData() ).toHaveKey( <span class="hljs-string">"token,user"</span> );

						<span class="hljs-keyword">var</span> decoded = jwtService.decode( response.getData().token );
						expect( decoded.sub ).toBe( <span class="hljs-number">10</span> );
						expect( decoded.exp ).toBeGTE( dateAdd( <span class="hljs-string">"h"</span>, <span class="hljs-number">1</span>, decoded.iat ) );
						expect( decoded.sub ).toBe( response.getData().user.id );
					} );
				} );
				given( <span class="hljs-string">"invalid email and password"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"I will receive a 401 exception "</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
						<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>.post(
							route  = <span class="hljs-string">"/api/v1/login"</span>,
							params = {
								<span class="hljs-attr">email</span>    : <span class="hljs-string">"invalid"</span>,
								<span class="hljs-attr">password</span> : <span class="hljs-string">"invalid"</span>
							}
						);
						<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );
						expect( response ).toHaveStatus( <span class="hljs-number">401</span> );
					} );
				} );
			} );

			story( <span class="hljs-string">"I want to register into the system"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				given( <span class="hljs-string">"valid registration details"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"I should register, log in and get a token"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
						<span class="hljs-comment">// Use a user in the seeded db</span>
						<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>.post(
							route  = <span class="hljs-string">"/api/v1/register"</span>,
							params = {
								<span class="hljs-attr">name</span>     : <span class="hljs-string">"luis Majano"</span>,
								<span class="hljs-attr">email</span>    : <span class="hljs-string">"lmajano@coldbox.org"</span>,
								<span class="hljs-attr">username</span> : <span class="hljs-string">"lmajano"</span>,
								<span class="hljs-attr">password</span> : <span class="hljs-string">"lmajano"</span>
							}
						);
						<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );

						debug( response.getData() );

						expect( response ).toHaveStatus( <span class="hljs-number">200</span> );
						expect( response.getData() ).toHaveKey( <span class="hljs-string">"token,user"</span> );

						<span class="hljs-keyword">var</span> decoded = jwtService.decode( response.getData().token );
						expect( decoded.sub ).toBe( response.getData().user.id );
						expect( decoded.exp ).toBeGTE( dateAdd( <span class="hljs-string">"h"</span>, <span class="hljs-number">1</span>, decoded.iat ) );
					} );
				} );
				given( <span class="hljs-string">"invalid registration details"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"I should get an error message"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
						<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>.post(
							route  = <span class="hljs-string">"/api/v1/register"</span>,
							params = {
								<span class="hljs-attr">email</span>    : <span class="hljs-string">"invalid"</span>,
								<span class="hljs-attr">password</span> : <span class="hljs-string">"invalid"</span>
							}
						);
						<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );
						expect( event.getResponse() ).toHaveStatus( <span class="hljs-number">400</span> );
					} );
				} );
				xgiven( <span class="hljs-string">"valid registration data but with a non-unique username"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"a validation message should be sent to the user with an error message"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					} );
				} );
			} );

			story( <span class="hljs-string">"I want to be able to logout from the system using my JWT token"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
				given( <span class="hljs-string">"a valid incoming jwt token"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"my token should become invalidated and I will be logged out"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
						<span class="hljs-comment">// Log in first to get a valid token to logout with</span>
						<span class="hljs-keyword">var</span> token   = jwtService.attempt( <span class="hljs-string">"Milkshake10"</span>, <span class="hljs-string">"test"</span> );
						<span class="hljs-keyword">var</span> payload = jwtService.decode( token );
						expect( cbauth.isLoggedIn() ).toBeTrue();

						<span class="hljs-comment">// Now Logout</span>
						<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>.post( route = <span class="hljs-string">"/api/v1/logout"</span>, params = { <span class="hljs-string">"x-auth-token"</span> : token } );

						<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );
						expect( response ).toHaveStatus( <span class="hljs-number">200</span> );
						expect( cbauth.isLoggedIn() ).toBeFalse();
					} );
				} );
				given( <span class="hljs-string">"an invalid incoming jwt token"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
					then( <span class="hljs-string">"I should see an error message"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
						<span class="hljs-comment">// Now Logout</span>
						<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">this</span>.post( route = <span class="hljs-string">"/api/v1/logout"</span>, params = { <span class="hljs-string">"x-auth-token"</span> : <span class="hljs-string">"123"</span> } );

						<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );
						expect( response.getError() ).toBeTrue( response.getMessages().toString() );
						expect( response ).toHaveStatus( <span class="hljs-number">500</span> );
					} );
				} );
			} );
		} );
	}

}
</div></code></pre>
<h3 id="routing">Routing</h3>
<p>Open the <code>v1</code> module's router: <code>modules_app/api/modules_app/v1/config/Router.cfc</code> and make sure our login/logout routes are there:</p>
<pre class="hljs"><code><div>component {

	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">configure</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-comment">// API Echo</span>
		<span class="hljs-keyword">get</span>( "/", "Echo.index" );

		// API Authentication Routes
		post( "/login", "Auth.login" );
		post( "/logout", "Auth.logout" );
		post( "/register", "Auth.register" );

		// API Secured Routes
		<span class="hljs-keyword">get</span>( "/whoami", "Echo.whoami" );


		route( "/:handler/:action" ).end();
	}

}

</div></code></pre>
<p>Issue a <code>coldbox reinit</code> and check out the Route Visualizer: http://127.0.0.1:42518/route-visualizer</p>
<h3 id="event-handler">Event Handler</h3>
<p>Let's go back to our <code>auth</code> handler and finalize the login/logout actions.</p>
<pre class="hljs"><code><div><span class="hljs-comment">/**
 * Authentication Handler
 */</span>
component extends=<span class="hljs-string">"coldbox.system.RestHandler"</span> {

	<span class="hljs-comment">// Injection</span>
	property name=<span class="hljs-string">"userService"</span> inject=<span class="hljs-string">"UserService"</span>;

	<span class="hljs-comment">/**
	 * Login a user into the application
	 *
	 * @x-route (POST) /api/v1/login
	 * @requestBody ~api/v1/auth/login/requestBody.json
	 * @response-default ~api/v1/auth/login/responses.json##200
	 * @response-401 ~api/v1/auth/login/responses.json##401
	 */</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"> event, rc, prc </span>) </span>{
		param rc.username = <span class="hljs-string">""</span>;
		param rc.password = <span class="hljs-string">""</span>;

		prc.token = jwtAuth().attempt( rc.username, rc.password );

		prc.response
			.setData( {
				<span class="hljs-string">"token"</span> : prc.token,
				<span class="hljs-string">"user"</span>  : cbSecure()
					.getAuthService()
					.getUser()
					.getMemento()
			} )
			.addMessage( <span class="hljs-string">"Bearer token created and it expires in #jwtAuth().getSettings().jwt.expiration# minutes"</span> );
	}

	<span class="hljs-comment">/**
	 * Register a new user in the system
	 *
	 * <span class="hljs-doctag">@x</span>-route (POST) /api/v1/register
	 * <span class="hljs-doctag">@requestBody </span>~api/v1/auth/register/requestBody.json
	 * <span class="hljs-doctag">@response</span>-default ~api/v1/auth/register/responses.json##200
	 * <span class="hljs-doctag">@response</span>-400 ~api/v1/auth/register/responses.json##400
	 */</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span>(<span class="hljs-params"> event, rc, prc </span>) </span>{
		param rc.fname    = <span class="hljs-string">""</span>;
		param rc.lname    = <span class="hljs-string">""</span>;
		param rc.email    = <span class="hljs-string">""</span>;
		param rc.password = <span class="hljs-string">""</span>;

		<span class="hljs-comment">// Populate, Validate, Create a new user</span>
		prc.oUser = userService.create( validateOrFail( populateModel( <span class="hljs-string">"User"</span> ) ) );

		<span class="hljs-comment">// Log them in if it was created!</span>
		event
			.getResponse()
			.setData( {
				<span class="hljs-string">"token"</span> : jwtAuth().fromuser( prc.oUser ),
				<span class="hljs-string">"user"</span>  : prc.oUser.getMemento()
			} )
			.addMessage(
				<span class="hljs-string">"User registered correctly and Bearer token created and it expires in #jwtAuth().getSettings().jwt.expiration# minutes"</span>
			);
	}

	<span class="hljs-comment">/**
	 * Logout a user
	 *
	 * <span class="hljs-doctag">@x</span>-route (POST) /api/v1/logout
	 * <span class="hljs-doctag">@security </span>bearerAuth,ApiKeyAuth
	 * <span class="hljs-doctag">@response</span>-default ~api/v1/auth/logout/responses.json##200
	 * <span class="hljs-doctag">@response</span>-500 ~api/v1/auth/logout/responses.json##500
	 */</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logout</span>(<span class="hljs-params"> event, rc, prc </span>) </span>{
		jwtAuth().logout();
		event.getResponse().addMessage( <span class="hljs-string">"Successfully logged out"</span> )
	}

}
</div></code></pre>
<p>Wow, our handlers look so nice and tidy and with strange documentation!  However, we still need to build out our User Service that will power all this goodness.</p>
<p>Please check out all of the jwt service methods, there are tons of them and really helpful!</p>
<p>https://coldbox-security.ortusbooks.com/jwt/jwt-services</p>
<h3 id="userservice">UserService</h3>
<p>In order for the jwt services and cbauth can authenticate and create tokens for us, we must adhere to the following interface (https://coldbox-security.ortusbooks.com/usage/authentication-services#user-services).  This is needed so the calls in our handlers can work correctly as the cbauth and jwt services will be calling our user services and leveraging our User object.</p>
<pre class="hljs"><code><div>interface{

	<span class="hljs-comment">/**
	 * Verify if the incoming username/password are valid credentials.
	 *
	 * <span class="hljs-doctag">@username </span>The username
	 * <span class="hljs-doctag">@password </span>The password
	 */</span>
	boolean <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isValidCredentials</span>(<span class="hljs-params"> required username, required password </span>);

	/**
	 * <span class="hljs-title">Retrieve</span> <span class="hljs-title">a</span> <span class="hljs-title">user</span> <span class="hljs-title">by</span> <span class="hljs-title">username</span>
	 *
	 * @<span class="hljs-title">return</span> <span class="hljs-title">User</span> <span class="hljs-title">that</span> <span class="hljs-title">implements</span> <span class="hljs-title">JWTSubject</span> <span class="hljs-title">and</span>/<span class="hljs-title">or</span> <span class="hljs-title">IAuthUser</span>
	 */
	<span class="hljs-title">function</span> <span class="hljs-title">retrieveUserByUsername</span>(<span class="hljs-params"> required username </span>);

	/**
	 * <span class="hljs-title">Retrieve</span> <span class="hljs-title">a</span> <span class="hljs-title">user</span> <span class="hljs-title">by</span> <span class="hljs-title">unique</span> <span class="hljs-title">identifier</span>
	 *
	 * @<span class="hljs-title">id</span> <span class="hljs-title">The</span> <span class="hljs-title">unique</span> <span class="hljs-title">identifier</span>
	 *
	 * @<span class="hljs-title">return</span> <span class="hljs-title">User</span> <span class="hljs-title">that</span> <span class="hljs-title">implements</span> <span class="hljs-title">JWTSubject</span> <span class="hljs-title">and</span>/<span class="hljs-title">or</span> <span class="hljs-title">IAuthUser</span>
	 */
	<span class="hljs-title">function</span> <span class="hljs-title">retrieveUserById</span>(<span class="hljs-params"> required id </span>);
}
</span></div></code></pre>
<p>That's it.  The jwt services and cbauth will know how to put everything together for you.  So let's build the service out.</p>
<pre class="hljs"><code><div><span class="hljs-comment">/**
 * User Services
 */</span>
component accessors=<span class="hljs-string">"true"</span> singleton {

	<span class="hljs-comment">/**
	 * --------------------------------------------------------------------------
	 * DI
	 * --------------------------------------------------------------------------
	 */</span>
	property name=<span class="hljs-string">"populator"</span> inject=<span class="hljs-string">"wirebox:populator"</span>;
	property name=<span class="hljs-string">"bcrypt"</span>    inject=<span class="hljs-string">"@BCrypt"</span>;
	property name=<span class="hljs-string">"qb"</span>        inject=<span class="hljs-string">"provider:QueryBuilder@qb"</span>;

	<span class="hljs-comment">/**
	 * Constructor
	 */</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>) </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
	}

	<span class="hljs-comment">/**
	 * Construct a new user object via WireBox
	 */</span>
	User <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new</span>(<span class="hljs-params"></span>) <span class="hljs-title">provider</span>="<span class="hljs-title">User</span>";

	/**
	 * <span class="hljs-title">Create</span> <span class="hljs-title">a</span> <span class="hljs-title">new</span> <span class="hljs-title">user</span> <span class="hljs-title">in</span> <span class="hljs-title">the</span> <span class="hljs-title">system</span>
	 *
	 * @<span class="hljs-title">user</span> <span class="hljs-title">The</span> <span class="hljs-title">user</span> <span class="hljs-title">to</span> <span class="hljs-title">create</span>
	 *
	 * @<span class="hljs-title">return</span> <span class="hljs-title">The</span> <span class="hljs-title">created</span> <span class="hljs-title">user</span>
	 */
	<span class="hljs-title">User</span> <span class="hljs-title">function</span> <span class="hljs-title">create</span>(<span class="hljs-params"> required user </span>) </span>{
		<span class="hljs-keyword">var</span> qResults = qb
			.from( <span class="hljs-string">"users"</span> )
			.insert(
				values = {
					<span class="hljs-string">"name"</span>     : <span class="hljs-built_in">arguments</span>.user.getName(),
					<span class="hljs-string">"email"</span>    : <span class="hljs-built_in">arguments</span>.user.getEmail(),
					<span class="hljs-string">"username"</span> : <span class="hljs-built_in">arguments</span>.user.getUsername(),
					<span class="hljs-string">"password"</span> : bcrypt.hashPassword( <span class="hljs-built_in">arguments</span>.user.getPassword() )
				}
			);

		<span class="hljs-comment">// populate the id</span>
		<span class="hljs-built_in">arguments</span>.user.setId( qResults.result.generatedKey );

		<span class="hljs-keyword">return</span> <span class="hljs-built_in">arguments</span>.user;
	}

	<span class="hljs-comment">/**
	 * Verify if the incoming username/password are valid credentials.
	 *
	 * <span class="hljs-doctag">@username </span>The username
	 * <span class="hljs-doctag">@password </span>The password
	 */</span>
	boolean <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isValidCredentials</span>(<span class="hljs-params"> required username, required password </span>) </span>{
		<span class="hljs-keyword">var</span> oTarget = retrieveUserByUsername( <span class="hljs-built_in">arguments</span>.username );
		<span class="hljs-keyword">if</span> ( !oTarget.isLoaded() ) {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
		}

		<span class="hljs-comment">// Check Password Here: Remember to use bcrypt</span>
		<span class="hljs-keyword">try</span> {
			<span class="hljs-keyword">return</span> variables.bcrypt.checkPassword( <span class="hljs-built_in">arguments</span>.password, oTarget.getPassword() );
		} <span class="hljs-keyword">catch</span> ( any e ) {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
		}
	}

	<span class="hljs-comment">/**
	 * Retrieve a user by username
	 *
	 * <span class="hljs-doctag">@return </span>User that implements JWTSubject and/or IAuthUser
	 */</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retrieveUserByUsername</span>(<span class="hljs-params"> required username </span>) </span>{
		<span class="hljs-keyword">return</span> populator.populateFromStruct(
			<span class="hljs-keyword">new</span> (),
			qb.from( <span class="hljs-string">"users"</span> )
				.where( <span class="hljs-string">"username"</span>, <span class="hljs-built_in">arguments</span>.username )
				.first()
		);
	}

	<span class="hljs-comment">/**
	 * Retrieve a user by unique identifier
	 *
	 * <span class="hljs-doctag">@id </span>The unique identifier
	 *
	 * <span class="hljs-doctag">@return </span>User that implements JWTSubject and/or IAuthUser
	 */</span>
	User <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">retrieveUserById</span>(<span class="hljs-params"> required id </span>) </span>{
		<span class="hljs-keyword">return</span> populator.populateFromStruct(
			<span class="hljs-keyword">new</span> (),
			qb.from( <span class="hljs-string">"users"</span> )
				.where( <span class="hljs-string">"id"</span>, <span class="hljs-built_in">arguments</span>.id )
				.first()
		);
	}

}
</div></code></pre>
<p>That's it!  Go run your tests and make sure all the tests pass!  What have you learned?</p>
<h2 id="invalid-routes">Invalid Routes</h2>
<p>Ok, so what would happen if we try to execute <code>/api/v1/bogus</code> in the browser?  Go and try it!</p>
<p>You will see that the browser blows up with a nasty invalid event. actually, ANY route we try to execute in the <code>v1</code> api will fail like this and this is not nice.  We want uniformity, so let's add a catch all route that issues the Rest Handler's <code>onInvalidRoute()</code> method.</p>
<p>Open the <code>v1</code> router and add the invalid routes catch all before the default route and actually remove the default route as we won't be using it.</p>
<pre class="hljs"><code><div>// Invalid Routes
route( &quot;/:anything&quot;, &quot;echo.onInvalidRoute&quot; );

//route( &quot;/:handler/:action&quot; ).end();
</div></code></pre>
<p>Issue a nice <code>coldbox reinit</code> and hit the route again or any invalid route and you should see a nice API return 404 message. Now, this is great, but we lost something? Anybody can guess?</p>
<blockquote>
<p>We lost all of our convention based routing which was below it.  This means, that we must register all the routes we want.</p>
</blockquote>
<h2 id="swagger">Swagger</h2>
<p>Ok, before we go any further building stuff out, let's go over the weird documentation in our handlers.  Go open one and try to decipher it? We are using cbswagger directives so we can document our API.  Go to http://127.0.0.1:42518/cbswagger and see the json created for you.  Copy it and go to https://editor.swagger.io/ and paste it in.</p>
<p>WOW! Our API is fully documented! What magic unicorn is this!</p>
<ul>
<li>https://www.forgebox.io/view/cbswagger</li>
<li>https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.2.md</li>
</ul>
<h3 id="customize-it">Customize It</h3>
<p>Open your <code>config/ColdBox.cfc</code> and  under the <code>moduleSettings</code> there is a <code>cbSwagger</code> section. Let's update it a bit to match what we are building:</p>
<pre class="hljs"><code><div>cbswagger : {
	<span class="hljs-comment">// The route prefix to search.  Routes beginning with this prefix will be determined to be api routes</span>
	<span class="hljs-string">"routes"</span>        : [ <span class="hljs-string">"api"</span> ],
	<span class="hljs-comment">// Any routes to exclude</span>
	<span class="hljs-string">"excludeRoutes"</span> : [ <span class="hljs-string">"api/v1/:anything/"</span> ],
	<span class="hljs-comment">// The default output format: json or yml</span>
	<span class="hljs-string">"defaultFormat"</span> : <span class="hljs-string">"json"</span>,
	<span class="hljs-comment">// A convention route, relative to your app root, where request/response samples are stored ( e.g. resources/apidocs/responses/[module].[handler].[action].[HTTP Status Code].json )</span>
	<span class="hljs-string">"samplesPath"</span>   : <span class="hljs-string">"resources/apidocs"</span>,
	<span class="hljs-comment">// Information about your API</span>
	<span class="hljs-string">"info"</span>          : {
		<span class="hljs-comment">// A title for your API</span>
		<span class="hljs-string">"title"</span>       : <span class="hljs-string">"Hero to SuperHero Headless CMS"</span>,
		<span class="hljs-comment">// A description of your API</span>
		<span class="hljs-string">"description"</span> : <span class="hljs-string">"A nice hmvc headless CMS"</span>,
		<span class="hljs-comment">// The contact email address</span>
		<span class="hljs-string">"contact"</span>     : {
			<span class="hljs-string">"name"</span>  : <span class="hljs-string">"API Support"</span>,
			<span class="hljs-string">"url"</span>   : <span class="hljs-string">"https://www.swagger.io/support"</span>,
			<span class="hljs-string">"email"</span> : <span class="hljs-string">"info@ortussolutions.com"</span>
		},
		<span class="hljs-comment">// A url to the License of your API</span>
		<span class="hljs-string">"license"</span> : {
			<span class="hljs-string">"name"</span> : <span class="hljs-string">"Apache 2.0"</span>,
			<span class="hljs-string">"url"</span>  : <span class="hljs-string">"https://www.apache.org/licenses/LICENSE-2.0.html"</span>
		},
		<span class="hljs-comment">// The version of your API</span>
		<span class="hljs-string">"version"</span> : <span class="hljs-string">"1.0.0"</span>
	},
	<span class="hljs-comment">// Tags</span>
	<span class="hljs-string">"tags"</span>         : [ ],
	<span class="hljs-comment">// https://swagger.io/specification/#externalDocumentationObject</span>
	<span class="hljs-string">"externalDocs"</span> : {
		<span class="hljs-string">"description"</span> : <span class="hljs-string">"Find more info here"</span>,
		<span class="hljs-string">"url"</span>         : <span class="hljs-string">"https://blog.readme.io/an-example-filled-guide-to-swagger-3-2/"</span>
	},
	<span class="hljs-comment">// https://swagger.io/specification/#serverObject</span>
	<span class="hljs-string">"servers"</span> : [
		{
			<span class="hljs-string">"url"</span>         : <span class="hljs-string">"https://mysite.com/v1"</span>,
			<span class="hljs-string">"description"</span> : <span class="hljs-string">"The main production server"</span>
		},
		{
			<span class="hljs-string">"url"</span>         : <span class="hljs-string">"http://127.0.0.1:42518"</span>,
			<span class="hljs-string">"description"</span> : <span class="hljs-string">"The dev server"</span>
		}
	],
	<span class="hljs-comment">// An element to hold various schemas for the specification.</span>
	<span class="hljs-comment">// https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#componentsObject</span>
	<span class="hljs-string">"components"</span> : {
		<span class="hljs-comment">// Define your security schemes here</span>
		<span class="hljs-comment">// https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#securitySchemeObject</span>
		<span class="hljs-string">"securitySchemes"</span> : {
			<span class="hljs-string">"ApiKeyAuth"</span> : {
				<span class="hljs-string">"type"</span>        : <span class="hljs-string">"apiKey"</span>,
				<span class="hljs-string">"description"</span> : <span class="hljs-string">"User your JWT as an Api Key for security"</span>,
				<span class="hljs-string">"name"</span>        : <span class="hljs-string">"x-api-key"</span>,
				<span class="hljs-string">"in"</span>          : <span class="hljs-string">"header"</span>
			},
			<span class="hljs-string">"bearerAuth"</span> : {
				<span class="hljs-string">"type"</span>         : <span class="hljs-string">"http"</span>,
				<span class="hljs-string">"scheme"</span>       : <span class="hljs-string">"bearer"</span>,
				<span class="hljs-string">"bearerFormat"</span> : <span class="hljs-string">"JWT"</span>
			}
		}
	}

	<span class="hljs-comment">// A default declaration of Security Requirement Objects to be used across the API.</span>
	<span class="hljs-comment">// https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#securityRequirementObject</span>
	<span class="hljs-comment">// Only one of these requirements needs to be satisfied to authorize a request.</span>
	<span class="hljs-comment">// Individual operations may set their own requirements with `@security`</span>
	<span class="hljs-comment">// "security" : [</span>
	<span class="hljs-comment">//	{ "APIKey" : [] },</span>
	<span class="hljs-comment">//	{ "UserSecurity" : [] }</span>
	<span class="hljs-comment">// ]</span>
},
</div></code></pre>
<h3 id="resources">Resources</h3>
<p>You can also find all the resources we generated previously from our app template in the <code>resources/apidocs</code> folder. You will find here global schemas, and our routing by convention.  Let's explore them and update them accordingly since our model changed.</p>
<ul>
<li>Update all resources to match our new API structure.</li>
</ul>
<h3 id="fix-our-error-on-swaggerhub">Fix our Error on SwaggerHub</h3>
<p>You might see an error on top specifying the <code>{anything}</code> route we added. In all reality, this is an internal route, so we don't need it documented, so open your <code>config/Coldbox.cfc</code> and look for the <code>excludedRoutes</code> in the <code>cbSwagger</code> module settings:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Any routes to exclude</span>
<span class="hljs-string">"excludeRoutes"</span> : [ <span class="hljs-string">"api/v1/:anything/"</span>],
</div></code></pre>
<p>Regenerate the swagger doc and we have our internal routing removed! Voila!</p>
<h3 id="postman-automation">PostMan Automation</h3>
<p>Let's do one more mystical trick.  Copy the swagger json and open Postman. Look for the import and import our cbwagger.</p>
<p>WOW!  We know have imported all of our API into Postman for testing and even more sweet documentation!</p>
<h2 id="listing-content">Listing Content</h2>
<p>Ok, we have all the building blocks for now focusing on our first content stories:</p>
<pre class="hljs"><code><div>story( <span class="hljs-string">"In order to interact with content in the CMS you must be authenticated"</span> );
story( <span class="hljs-string">"I want to see content with different filtering options"</span> )
story( <span class="hljs-string">"I want to see a single content object via a nice slug"</span> )
</div></code></pre>
<p>Ok, let's start by modeling our content object</p>
<h3 id="contentcfc">Content.cfc</h3>
<p>We will be creating a <code>Content.cfc</code> that will store our headless content:</p>
<ul>
<li><code>id</code></li>
<li><code>slug</code></li>
<li><code>title</code></li>
<li><code>body</code></li>
<li><code>isPublished:boolean</code></li>
<li><code>publishedDate:date</code></li>
<li><code>createdDate:date</code></li>
<li><code>modifiedDate:date</code></li>
<li><code>user (many to one)</code></li>
</ul>
<p>Ok, let's creat it via CommandBox</p>
<pre class="hljs"><code><div>coldbox create model name=<span class="hljs-string">"Content"</span> properties=<span class="hljs-string">"id,slug,title,body,isPublished:boolean,publishedDate:date,createdDate:date,modifiedDate:date,FK_userID,user"</span>
</div></code></pre>
<p>Open up the object and the companion unit test.  Remember in our unit test, we just want quick verifications.</p>
<ul>
<li>Initialize the content object</li>
<li>Add an <code>isLoaded()</code> to verify persistence</li>
<li>Add a <code>getUser()</code> to retrieve the relationship, so we will need to inject the <code>UserService</code></li>
<li>Add the mementifier instructions</li>
<li>Add the validation constraints</li>
</ul>
<pre class="hljs"><code><div><span class="hljs-comment">/**
* I am a new Model Object
*/</span>
component accessors=<span class="hljs-string">"true"</span>{

	<span class="hljs-comment">// inject the user service</span>
	property name=<span class="hljs-string">"userService"</span> inject=<span class="hljs-string">"UserService"</span>;

	<span class="hljs-comment">// Properties</span>
	property name=<span class="hljs-string">"id"</span>            type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"slug"</span>          type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"title"</span>         type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"body"</span>          type=<span class="hljs-string">"string"</span>;
	property name=<span class="hljs-string">"isPublished"</span>   type=<span class="hljs-string">"boolean"</span>;
	property name=<span class="hljs-string">"publishedDate"</span> type=<span class="hljs-string">"date"</span>;
	property name=<span class="hljs-string">"createdDate"</span>   type=<span class="hljs-string">"date"</span>;
	property name=<span class="hljs-string">"modifiedDate"</span>  type=<span class="hljs-string">"date"</span>;
	property name=<span class="hljs-string">"FK_userID"</span>     type=<span class="hljs-string">"string"</span> <span class="hljs-keyword">default</span>=<span class="hljs-string">""</span>;

	<span class="hljs-keyword">this</span>.constraints = {
        <span class="hljs-attr">slug</span>    	: { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span>, <span class="hljs-attr">udf</span> : <span class="hljs-function">(<span class="hljs-params"> value, target </span>) =&gt;</span> {
			<span class="hljs-keyword">if</span>( isNull( <span class="hljs-built_in">arguments</span>.value ) ) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">return</span> qb.from( <span class="hljs-string">"content"</span> ).where( <span class="hljs-string">"slug"</span>, <span class="hljs-built_in">arguments</span>.value ).count() == <span class="hljs-number">0</span>;
		}},
		<span class="hljs-attr">title</span>       : { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span> },
		<span class="hljs-attr">body</span>       	: { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span> },
		<span class="hljs-attr">FK_userID</span>	: { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span> }
	};

	<span class="hljs-keyword">this</span>.memento = {
		defaultIncludes = [
			<span class="hljs-string">"slug"</span>,
			<span class="hljs-string">"title"</span>,
			<span class="hljs-string">"body"</span>,
			<span class="hljs-string">"isPublished"</span>,
			<span class="hljs-string">"publishedDate"</span>,
			<span class="hljs-string">"createdDate"</span>,
			<span class="hljs-string">"modifiedDate"</span>,
			<span class="hljs-string">"user.name"</span>,
			<span class="hljs-string">"user.email"</span>
		],
		defaultExcludes = [
			<span class="hljs-string">"FK_userID"</span>,
			<span class="hljs-string">"user.id"</span>,
			<span class="hljs-string">"user.username"</span>,
			<span class="hljs-string">"user.modifiedDate"</span>,
			<span class="hljs-string">"user.createdDate"</span>
		]
	};

	<span class="hljs-comment">/**
	 * Constructor
	 */</span>
	Content <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>)</span>{
		variables.createdDate 	= now();
		variables.modifiedDate 	= now();
		variables.isPublished 	= <span class="hljs-literal">false</span>;
		variables.FK_userID 	= <span class="hljs-string">""</span>;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
	}

	boolean <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isLoaded</span>(<span class="hljs-params"></span>)</span>{
		<span class="hljs-keyword">return</span> ( !isNull( variables.id ) &amp;&amp; len( variables.id ) );
	}

	User <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getUser</span>(<span class="hljs-params"></span>)</span>{
		<span class="hljs-keyword">return</span> variables.userService.retrieveUserById( variables.FK_userId );
	}

	Content <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setUser</span>(<span class="hljs-params"> required user </span>)</span>{
		<span class="hljs-keyword">if</span>( user.isLoaded() ){
			variables.FK_userId = <span class="hljs-built_in">arguments</span>.user.getId();
		}
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
	}

}
</div></code></pre>
<p>Update your tests:</p>
<pre class="hljs"><code><div>describe( <span class="hljs-string">"Content Object"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{

	it( <span class="hljs-string">"can be created"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		expect( model ).toBeComponent();
	});

});
</div></code></pre>
<p>Verify we can compile by running your tests!</p>
<h3 id="bdd">BDD</h3>
<p>Now that we have our model let's start with the stories and integration. We can create a nice ColdBox resource for our content: <code>resources( &quot;content&quot; )</code> and it will provide us with the following:</p>
<ul>
<li><code>GET:content.index</code> 			: Display all content objects</li>
<li><code>POST:content.create</code> 		: Create a content object</li>
<li><code>GET:content.show</code> 			: Display a single content</li>
<li><code>PUT/PATCH:content.update</code> 	: Update a content object</li>
<li><code>DELETE:content.delete</code> 		: Remove a content object</li>
</ul>
<pre class="hljs"><code><div>coldbox create handler name=<span class="hljs-string">"content"</span> actions=<span class="hljs-string">"index,create,show,update,delete"</span> directory=modules_app/api/modules_app/v1/handlers
</div></code></pre>
<p>Let's open up the specs and start building it out:</p>
<pre class="hljs"><code><div>describe( <span class="hljs-string">"Content Services: In order to interact with content in the CMS you must be authenticated"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{

	beforeEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"> currentSpec </span>)</span>{
		<span class="hljs-comment">// Setup as a new ColdBox request for this suite, VERY IMPORTANT. ELSE EVERYTHING LOOKS LIKE THE SAME REQUEST.</span>
		setup();
		<span class="hljs-comment">// Need to login</span>
		jwt = jwtService.attempt( <span class="hljs-string">"Milkshake10"</span>, <span class="hljs-string">"test"</span> );
		getRequestContext().setValue( <span class="hljs-string">"x-auth-token"</span>, jwt );
	});

	story( <span class="hljs-string">"I want to be able to see content with different options"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		it( <span class="hljs-string">"should display all content using the default options"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
			<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">get</span>( route = "/api/v1/content" );
			var response = event.getPrivateValue( "Response" );
			expect( response ).toHaveStatus( 200 );
			expect( response.getData() ).toBeArray();
		});
	});

	story( "I want to see a single content object via a nice slug", function(){
		given( <span class="hljs-string">"a valid slug"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
			then( <span class="hljs-string">"I should be able to display the content object"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
				<span class="hljs-keyword">var</span> testSlug = <span class="hljs-string">"Spoon-School-Staircase"</span>;
				<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">get</span>( route = "/api/v1/content/#testSlug#" );
				var response = event.getPrivateValue( "Response" );

				debug( response.getMessages() );

				expect( response ).toHaveStatus( 200 );
				expect( response.getData() ).toBeStruct();
				expect( response.getData().slug ).toBe( testSlug );
			});
		});

		given( "an invalid slug", function(){
			then( <span class="hljs-string">"then we should get a 404"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
				<span class="hljs-keyword">var</span> testSlug = <span class="hljs-string">"invalid-bogus-object"</span>;
				<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">get</span>( route = "/api/v1/content/#testSlug#" );
				var response = event.getPrivateValue( "Response" );

				debug( response.getMessages() );

				expect( response ).toHaveStatus( 404 );
			});
		});
	});
	
} );
</div></code></pre>
<h3 id="security">Security</h3>
<p>Now that we have our handler generated, we will secure it using a rule. Open the <code>config/ColdBox.cfc</code> and add the following rule to the <code>cbsecurity.rules</code> array:</p>
<pre class="hljs"><code><div>{
	secureList 	: &quot;v1:content&quot;
}
</div></code></pre>
<p>That's it!  Now any requests made to that secure pattern will be inspected by the JWT Validator and a bearer token must be valid to access it!  BOOM!</p>
<p>You can also secure using annotations, we can get rid of the rule and then in our handler we can add the <code>secured</code> annotation to the <code>component</code> definition.  Same Approach.</p>
<h3 id="routing">Routing</h3>
<p>Let's add our routing as we explained above in our <code>v1</code> router.</p>
<pre class="hljs"><code><div>resources( resource=<span class="hljs-string">"content"</span>, parameterName=<span class="hljs-string">"slug"</span> );
</div></code></pre>
<p>Please note that we change the parameter name to <code>slug</code> since we will use those unique slugs for operation and not the Id.</p>
<h3 id="event-handler">Event Handler</h3>
<p>Now let's build out the handler that can satisfy our previous stories</p>
<pre class="hljs"><code><div><span class="hljs-comment">/**
* I am a new handler
*/</span>
component extends=<span class="hljs-string">"coldbox.system.RestHandler"</span> {

	property name=<span class="hljs-string">"contentService"</span> inject=<span class="hljs-string">"ContentService"</span>;

	<span class="hljs-comment">/**
	 * index
	 */</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params"> event, rc, prc </span>) </span>{
		prc.response.setData(
			contentService
				.list()
				.map( <span class="hljs-function">(<span class="hljs-params"> item </span>) =&gt;</span> {
					<span class="hljs-keyword">return</span> item.getMemento();
				} )
		);
	}

	<span class="hljs-comment">/**
	* create
	*/</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params"> event, rc, prc </span>)</span>{
		event.setView( <span class="hljs-string">"content/create"</span> );
	}

	<span class="hljs-comment">/**
	 * show
	 */</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">show</span>(<span class="hljs-params"> event, rc, prc </span>) </span>{
		param rc.slug = <span class="hljs-string">""</span>;

		prc.oContent = contentService.findBySlug( rc.slug );

		<span class="hljs-keyword">if</span> ( !prc.oContent.isLoaded() ) {
			prc.response
				.setError( <span class="hljs-literal">true</span> )
				.setStatusCode( event.STATUS.NOT_FOUND )
				.setStatusText( <span class="hljs-string">"Not Found"</span> )
				.addMessage( <span class="hljs-string">"The requested content object (#rc.slug#) could not be found"</span> );
			<span class="hljs-keyword">return</span>;
		}

		prc.response.setData( prc.oContent.getMemento() );
	}

	<span class="hljs-comment">/**
	* update
	*/</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span>(<span class="hljs-params"> event, rc, prc </span>)</span>{
		event.setView( <span class="hljs-string">"content/update"</span> );
	}

	<span class="hljs-comment">/**
	* delete
	*/</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delete</span>(<span class="hljs-params"> event, rc, prc </span>)</span>{
		event.setView( <span class="hljs-string">"content/delete"</span> );
	}

}
</div></code></pre>
<h3 id="content-services">Content Services</h3>
<p>Ok, now we need to focus on our Content Services that will power the handler since we already created the Content object, so we need to implement the <code>findBySlug()</code> and the <code>list()</code> methods:</p>
<p>Let's generate what we need:</p>
<pre class="hljs"><code><div>coldbox create model name=<span class="hljs-string">"ContentService"</span> persistence=<span class="hljs-string">"singleton"</span> methods=<span class="hljs-string">"list,get,findBySlug"</span>
</div></code></pre>
<p>Also open the unit test and do a quick compile test:</p>
<pre class="hljs"><code><div>describe( <span class="hljs-string">"ContentService Suite"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{

	it( <span class="hljs-string">"can be created"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		expect( model ).toBeComponent();
	});

});
</div></code></pre>
<p>Now let's build it out:</p>
<pre class="hljs"><code><div><span class="hljs-comment">/**
* I am a new Model Object
*/</span>
component singleton accessors=<span class="hljs-string">"true"</span>{

	<span class="hljs-comment">// Properties</span>
	property name=<span class="hljs-string">"populator"</span> 	inject=<span class="hljs-string">"wirebox:populator"</span>;
	property name=<span class="hljs-string">"qb"</span>          inject=<span class="hljs-string">"provider:QueryBuilder@qb"</span>;


	<span class="hljs-comment">/**
	 * Constructor
	 */</span>
	ContentService <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span>(<span class="hljs-params"></span>)</span>{
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
	}

	Content <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">new</span>(<span class="hljs-params"></span>) <span class="hljs-title">provider</span>="<span class="hljs-title">Content</span>";

	/**
	* <span class="hljs-title">list</span>
	*/
	<span class="hljs-title">array</span> <span class="hljs-title">function</span> <span class="hljs-title">list</span>(<span class="hljs-params"> orderBy=<span class="hljs-string">"publishedDate"</span>, orderType=<span class="hljs-string">"asc"</span> </span>)</span>{
		<span class="hljs-keyword">return</span> qb
			.from( <span class="hljs-string">"content"</span> )
			.orderBy( <span class="hljs-built_in">arguments</span>.orderBy, <span class="hljs-built_in">arguments</span>.orderType )
			.get()
			.map( <span class="hljs-function">(<span class="hljs-params"> content </span>) =&gt;</span> {
				<span class="hljs-keyword">return</span> populator.populateFromStruct(
					<span class="hljs-keyword">new</span>(),
					content
				);
			} );
	}

	<span class="hljs-comment">/**
	* get
	*/</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params"> required id </span>)</span>{
		<span class="hljs-keyword">return</span> populator.populateFromStruct(
            <span class="hljs-keyword">new</span>(),
            qb.from( <span class="hljs-string">"content"</span> ).where( <span class="hljs-string">"id"</span> , <span class="hljs-built_in">arguments</span>.id ).first()
        );
	}

	<span class="hljs-comment">/**
	* Find by slug
	*/</span>
	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findBySlug</span>(<span class="hljs-params"> required slug </span>)</span>{
		<span class="hljs-keyword">return</span> populator.populateFromStruct(
            <span class="hljs-keyword">new</span>(),
            qb.from( <span class="hljs-string">"content"</span> ).where( <span class="hljs-string">"slug"</span> , <span class="hljs-built_in">arguments</span>.slug ).first()
        );
	}


}
</div></code></pre>
<p>Ok, it seems we are done, let's run our tests and make sure we are listing all content and getting a single content.</p>
<p><strong>Extra Credit:</strong> Leverage postman to test these endpoints. Remember you must get a jwt token first!</p>
<h2 id="creating-content">Creating Content</h2>
<p>Ok, we can list all and one piece of content, let's try creating one now.</p>
<pre class="hljs"><code><div>story( <span class="hljs-string">"I want to be able to create content objects"</span> )
</div></code></pre>
<p>I don't have to do any more setup for security, resources or even handlers.  We have our resourceful handler already.  So let's delve into the BDD first.</p>
<h3 id="bdd">BDD</h3>
<p>Update the spec with a new story and scenarios:`</p>
<pre class="hljs"><code><div>story( <span class="hljs-string">"I want to be able to create new content objects"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
	given( <span class="hljs-string">"valid incoming data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		then( <span class="hljs-string">"it should create a new content object"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
			<span class="hljs-keyword">var</span> event = post(
				route = <span class="hljs-string">"/api/v1/content"</span>,
				params = {
					<span class="hljs-attr">slug</span>          : <span class="hljs-string">"my-new-test-#createUUID()#"</span>,
					<span class="hljs-attr">title</span>         : <span class="hljs-string">"I love BDD"</span>,
					<span class="hljs-attr">body</span>          : <span class="hljs-string">"I love BDD sooooooooooo much!"</span>,
					<span class="hljs-attr">isPublished</span>   : <span class="hljs-literal">true</span>,
					<span class="hljs-attr">publishedDate</span> : now()
				}
			)

			<span class="hljs-comment">// expectations go here.</span>
			<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );

			debug( response.getData() );

			expect( response ).toHaveStatus( <span class="hljs-number">200</span> );
			expect( response.getData().title ).toBe( <span class="hljs-string">"I love BDD"</span> );
			expect( response.getData().id ).notToBeEmpty();
		});
	});

	given( <span class="hljs-string">"invalid data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		then( <span class="hljs-string">"it should throw a validation error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
			<span class="hljs-keyword">var</span> event = post(
				route = <span class="hljs-string">"/api/v1/content"</span>,
				params = {
					<span class="hljs-attr">body</span>          : <span class="hljs-string">"I love BDD sooooooooooo much!"</span>,
					<span class="hljs-attr">isPublished</span>   : <span class="hljs-literal">true</span>,
					<span class="hljs-attr">publishedDate</span> : now()
				}
			)

			<span class="hljs-comment">// expectations go here.</span>
			<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );

			expect( response ).toHaveStatus( <span class="hljs-number">400</span> );
			expect( response ).toHaveInvalidData( <span class="hljs-string">"slug"</span>, <span class="hljs-string">"is required"</span> );
		});
	});
});
</div></code></pre>
<p>Ok, now let's put it together!</p>
<h3 id="create-action">Create Action</h3>
<pre class="hljs"><code><div><span class="hljs-comment">/**
* create
*/</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params"> event, rc, prc </span>)</span>{

	<span class="hljs-comment">// populate, validate and create</span>
	prc.oContent = contentService.create(
		validateOrFail( populateModel( <span class="hljs-string">"Content"</span> ).setUser( jwtAuth().getUser() ) )
	);

	prc.response.setData( prc.oContent.getMemento() );
}
</div></code></pre>
<p>We have to also get the authenticated user to add it into the content.</p>
<h3 id="create-services">Create Services</h3>
<p>Now to the ugly (funky) SQL</p>
<pre class="hljs"><code><div><span class="hljs-comment">/**
* create
*/</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params"> required content </span>)</span>{
	<span class="hljs-keyword">var</span> qResults = qb.from( <span class="hljs-string">"content"</span> )
		.insert( values = {
			<span class="hljs-string">"slug"</span> 			= <span class="hljs-built_in">arguments</span>.content.getSlug(),
			<span class="hljs-string">"title"</span> 		= <span class="hljs-built_in">arguments</span>.content.getTitle(),
			<span class="hljs-string">"body"</span> 			= <span class="hljs-built_in">arguments</span>.content.getBody(),
			<span class="hljs-string">"isPublished"</span> 	= { <span class="hljs-attr">value</span> : <span class="hljs-built_in">arguments</span>.content.getIsPublished(), <span class="hljs-attr">cfsqltype</span> : <span class="hljs-string">"tinyint"</span> },
			<span class="hljs-string">"publishedDate"</span> = { <span class="hljs-attr">value</span> : <span class="hljs-built_in">arguments</span>.content.getPublishedDate(), <span class="hljs-attr">cfsqltype</span> : <span class="hljs-string">"timestamp"</span> },
			<span class="hljs-string">"createdDate"</span> 	= { <span class="hljs-attr">value</span> : now(), <span class="hljs-attr">cfsqltype</span> : <span class="hljs-string">"timestamp"</span> },
			<span class="hljs-string">"modifiedDate"</span> 	= { <span class="hljs-attr">value</span> : now(), <span class="hljs-attr">cfsqltype</span> : <span class="hljs-string">"timestamp"</span> },
			<span class="hljs-string">"FK_userId"</span>		= <span class="hljs-built_in">arguments</span>.content.getUser().getId()
		} );

	<span class="hljs-comment">// populate the id</span>
	<span class="hljs-built_in">arguments</span>.content.setId( qResults.result.generatedKey );

	<span class="hljs-keyword">return</span> <span class="hljs-built_in">arguments</span>.content;
}
</div></code></pre>
<p>Run your tests, validate and BOOM! Creation done! Next!</p>
<h2 id="updating-content">Updating Content</h2>
<pre class="hljs"><code><div>story( <span class="hljs-string">"I want to be able to update content objects"</span> )
</div></code></pre>
<p>I don't have to do any more setup for security, resources or even handlers.  We have our resourceful handler already.  So let's delve into the BDD first.</p>
<h3 id="bdd">BDD</h3>
<p>Update the spec with a new story and scenarios:`</p>
<pre class="hljs"><code><div>story( <span class="hljs-string">"I want to be able to update content objects"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
	given( <span class="hljs-string">"valid incoming data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		then( <span class="hljs-string">"it should update the content object"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
			<span class="hljs-keyword">var</span> event = put(
				route = <span class="hljs-string">"/api/v1/content/Record-Slave-Crystal"</span>,
				params = {
					<span class="hljs-attr">title</span>         : <span class="hljs-string">"I just changed you!"</span>,
					<span class="hljs-attr">body</span>          : <span class="hljs-string">"I love BDD sooooooooooo much!"</span>,
					<span class="hljs-attr">isPublished</span>   : <span class="hljs-literal">false</span>
				}
			)

			<span class="hljs-comment">// expectations go here.</span>
			<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );

			debug( response.getData() );

			expect( response ).toHaveStatus( <span class="hljs-number">200</span> );
			expect( response.getData().title ).toBe( <span class="hljs-string">"I just changed you!"</span> );
			expect( response.getData().id ).notToBeEmpty();
		});
	});

	given( <span class="hljs-string">"an invalid slug"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		then( <span class="hljs-string">"it should throw a validation error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
			<span class="hljs-keyword">var</span> event = put(
				route = <span class="hljs-string">"/api/v1/content/bogus"</span>,
				params = {
					<span class="hljs-attr">body</span>          : <span class="hljs-string">"I love BDD sooooooooooo much!"</span>,
					<span class="hljs-attr">isPublished</span>   : <span class="hljs-literal">true</span>,
					<span class="hljs-attr">publishedDate</span> : now()
				}
			)

			<span class="hljs-comment">// expectations go here.</span>
			<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );

			expect( response ).toHaveStatus( <span class="hljs-number">404</span> );
		});
	});
});
</div></code></pre>
<p>Ok, now let's put it together!</p>
<h3 id="update-action">Update Action</h3>
<pre class="hljs"><code><div><span class="hljs-comment">/**
 * update
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span>(<span class="hljs-params"> event, rc, prc </span>) </span>{
	param rc.slug = <span class="hljs-string">""</span>;

	prc.oContent = contentService.findBySlug( rc.slug );

	<span class="hljs-keyword">if</span> ( !prc.oContent.isLoaded() ) {
		prc.response
			.setError( <span class="hljs-literal">true</span> )
			.setStatusCode( event.STATUS.NOT_FOUND )
			.setStatusText( <span class="hljs-string">"Not Found"</span> )
			.addMessage( <span class="hljs-string">"The requested content object (#rc.slug#) could not be found"</span> );
		<span class="hljs-keyword">return</span>;
	}

	<span class="hljs-comment">// populate, validate and create</span>
	prc.oContent = contentService.update(
		validateOrFail( populateModel( prc.oContent ).setUser( jwtAuth().getUser() ) )
	);

	prc.response.setData( prc.oContent.getMemento() );
}
</div></code></pre>
<p>We have to also get the authenticated user to add it into the content.</p>
<h3 id="update-services">Update Services</h3>
<p>Now to the ugly (funky) SQL</p>
<pre class="hljs"><code><div><span class="hljs-comment">/**
* update
*/</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span>(<span class="hljs-params"> required content </span>)</span>{
	<span class="hljs-keyword">var</span> qResults = qb.from( <span class="hljs-string">"content"</span> )
		.whereId( <span class="hljs-built_in">arguments</span>.content.getId() )
		.update( {
			<span class="hljs-string">"slug"</span> 			= <span class="hljs-built_in">arguments</span>.content.getSlug(),
			<span class="hljs-string">"title"</span> 		= <span class="hljs-built_in">arguments</span>.content.getTitle(),
			<span class="hljs-string">"body"</span> 			= <span class="hljs-built_in">arguments</span>.content.getBody(),
			<span class="hljs-string">"isPublished"</span> 	= { <span class="hljs-attr">value</span> : <span class="hljs-built_in">arguments</span>.content.getIsPublished(), <span class="hljs-attr">cfsqltype</span> : <span class="hljs-string">"tinyint"</span> },
			<span class="hljs-string">"publishedDate"</span> = { <span class="hljs-attr">value</span> : <span class="hljs-built_in">arguments</span>.content.getPublishedDate(), <span class="hljs-attr">cfsqltype</span> : <span class="hljs-string">"timestamp"</span> },
			<span class="hljs-string">"modifiedDate"</span> 	= { <span class="hljs-attr">value</span> : now(), <span class="hljs-attr">cfsqltype</span> : <span class="hljs-string">"timestamp"</span> },
			<span class="hljs-string">"FK_userId"</span>		= <span class="hljs-built_in">arguments</span>.content.getUser().getId()
		} );

	<span class="hljs-keyword">return</span> <span class="hljs-built_in">arguments</span>.content;
}
</div></code></pre>
<p>Run your tests, validate and BOOM, validation errors!!! WHATTTTTT. What could be wrong?</p>
<h3 id="updating-the-unique-validator">Updating The Unique Validator</h3>
<p>It seems our validator is in need of some updating, since if we do an update it will claim that the slug is already there, but I want an update not a creation.  So let's udpate it.</p>
<pre class="hljs"><code><div>slug : { <span class="hljs-attr">required</span> : <span class="hljs-literal">true</span>, <span class="hljs-attr">udf</span> : <span class="hljs-function">(<span class="hljs-params"> value, target </span>) =&gt;</span> {
	<span class="hljs-keyword">if</span>( isNull( <span class="hljs-built_in">arguments</span>.value ) ) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
	<span class="hljs-keyword">return</span> qb.from( <span class="hljs-string">"content"</span> )
		.where( <span class="hljs-string">"slug"</span>, <span class="hljs-built_in">arguments</span>.value )
		.when( <span class="hljs-keyword">this</span>.isLoaded(), ( q ) =&gt; {
			<span class="hljs-built_in">arguments</span>.q.whereNotIn( <span class="hljs-string">"id"</span>, <span class="hljs-keyword">this</span>.getId() );
		} )
		.count() == <span class="hljs-number">0</span>;
}},
</div></code></pre>
<p>Check out the cool <code>when()</code> function. It allows us to switch up the SQL if the actual object has been persisted already. Now run your tests and we should be good now!</p>
<h2 id="removing-content">Removing Content</h2>
<pre class="hljs"><code><div>story( <span class="hljs-string">"I want to be able to remove content objects"</span> )
</div></code></pre>
<h3 id="bdd">BDD</h3>
<p>Update the spec with a new story and scenarios:`</p>
<pre class="hljs"><code><div>story( <span class="hljs-string">"I want to be able to remove content objects"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
	given( <span class="hljs-string">"a valid incoming slug"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		then( <span class="hljs-string">"it should remove content object"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
			<span class="hljs-keyword">var</span> event = DELETE(
				route = <span class="hljs-string">"/api/v1/content/Record-Slave-Crystal"</span>
			);

			<span class="hljs-comment">// expectations go here.</span>
			<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );

			debug( response.getData() );

			expect( response ).toHaveStatus( <span class="hljs-number">200</span> );
			expect( response.getMessages().toString() ).toInclude( <span class="hljs-string">"Content deleted"</span> );
		});
	});

	given( <span class="hljs-string">"an invalid slug"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
		then( <span class="hljs-string">"it should throw a validation error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
			<span class="hljs-keyword">var</span> event = <span class="hljs-keyword">delete</span>(
				route = <span class="hljs-string">"/api/v1/content/bogus"</span>
			);

			<span class="hljs-comment">// expectations go here.</span>
			<span class="hljs-keyword">var</span> response = event.getPrivateValue( <span class="hljs-string">"Response"</span> );

			expect( response ).toHaveStatus( <span class="hljs-number">404</span> );
		});
	});
});
</div></code></pre>
<p>Ok, now let's put it together!</p>
<h3 id="delete-action">Delete Action</h3>
<pre class="hljs"><code><div><span class="hljs-comment">/**
* delete
*/</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delete</span>(<span class="hljs-params"> event, rc, prc </span>)</span>{
	param rc.slug = <span class="hljs-string">""</span>;

	prc.oContent = contentService.findBySlug( rc.slug );

	<span class="hljs-keyword">if</span> ( !prc.oContent.isLoaded() ) {
		prc.response
			.setError( <span class="hljs-literal">true</span> )
			.setStatusCode( event.STATUS.NOT_FOUND )
			.setStatusText( <span class="hljs-string">"Not Found"</span> )
			.addMessage( <span class="hljs-string">"The requested content object (#rc.slug#) could not be found"</span> );
		<span class="hljs-keyword">return</span>;
	}

	<span class="hljs-comment">// populate, validate and create</span>
	contentService.delete( prc.oContent );

	prc.response.addMessage( <span class="hljs-string">"Content deleted!"</span> );
}
</div></code></pre>
<h3 id="delete-services">Delete Services</h3>
<p>Now to the ugly (funky) SQL</p>
<pre class="hljs"><code><div><span class="hljs-comment">/**
 * delete
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delete</span>(<span class="hljs-params"> required content </span>)</span>{
	<span class="hljs-keyword">var</span> qResults = qb.from( <span class="hljs-string">"content"</span> )
		.whereId( <span class="hljs-built_in">arguments</span>.content.getId() )
		.delete();

	<span class="hljs-built_in">arguments</span>.content.setId( <span class="hljs-string">""</span> );

	<span class="hljs-keyword">return</span> <span class="hljs-built_in">arguments</span>.content;
}
</div></code></pre>
<p>Run your tests!</p>
<h2 id="where-do-we-go-from-here">Where Do We Go From Here</h2>
<p>We should be excited, exhausted, and amazed that we have started to build a headless CMS!  This is just the start, what else can we do? Here are some more ideas?</p>
<ul>
<li>Content Versioning</li>
<li>Content Drafts</li>
<li>Content Categories</li>
<li>Move to an ORM (Hibernate or Quick)</li>
<li>Allow creator and editor in content objects</li>
<li>Pagination</li>
<li>Search</li>
<li>The list goes on!!!</li>
</ul>
<p>Happy Coding!</p>

</body>
</html>
